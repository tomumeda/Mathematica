(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 8.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       157,          7]
NotebookDataLength[     40254,       1245]
NotebookOptionsPosition[     38796,       1199]
NotebookOutlinePosition[     39376,       1220]
CellTagsIndexPosition[     39333,       1217]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["  scalarEDCcode", "Text",
 ShowGroupOpener->True,
 FontFamily->"Helvetica",
 FontSize->24,
 FontWeight->"Bold",
 FontColor->RGBColor[0, 0, 1]],

Cell["\tversion 3.6.0 - May 2007 ", "Text",
 FontSize->14,
 FontColor->RGBColor[0, 0, 1]],

Cell[CellGroupData[{

Cell["\<\
\tTo start a new set of calculations, just re-evaluate this notebook without \
first quitting the kernel. All symbols defined previously and all In/Out \
lines will be cleared, though memory used will not be recovered. \
\>", "Text",
 ShowGroupOpener->True,
 FontSize->16,
 FontColor->RGBColor[0, 0, 1]],

Cell[BoxData[
 RowBox[{
  RowBox[{"Off", "[", 
   RowBox[{
    RowBox[{"General", "::", "\"\<spell\>\""}], ",", 
    RowBox[{"General", "::", "\"\<spell1\>\""}], ",", 
    RowBox[{"Remove", "::", "\"\<rmnsm\>\""}], ",", 
    RowBox[{"UpSet", "::", "\"\<write\>\""}]}], "]"}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"Unprotect", "[", "\"\<Global`*\>\"", "]"}], ";", 
  RowBox[{"ClearAll", "[", "\"\<Global`*\>\"", "]"}], ";", 
  RowBox[{"Remove", "[", "\"\<Global`*\>\"", "]"}], ";", 
  RowBox[{"Unprotect", "[", 
   RowBox[{"In", ",", "Out"}], "]"}], ";", 
  RowBox[{"Clear", "[", 
   RowBox[{"In", ",", "Out"}], "]"}], ";", 
  RowBox[{"Protect", "[", 
   RowBox[{"In", ",", "Out"}], "]"}], ";", 
  RowBox[{"$Line", "=", "0"}], ";", 
  RowBox[{"$RecursionLimit", "=", "256"}], ";", 
  RowBox[{"$IterationLimit", "=", "4096"}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"Forms", "[", "i_", "]"}], ":=", 
   RowBox[{"{", "}"}]}], ";", 
  RowBox[{"AllScalForms", "=", 
   RowBox[{"{", "}"}]}], ";", 
  RowBox[{"AllDifForms", "=", 
   RowBox[{"{", "}"}]}], ";", 
  RowBox[{"AllSymbols", "=", 
   RowBox[{"{", "}"}]}], ";", 
  RowBox[{"FormVars", "=", 
   RowBox[{"{", 
    RowBox[{"_Wedge", ",", "_d"}], "}"}]}], ";", 
  RowBox[{"HeadList", "=", 
   RowBox[{"{", "}"}]}], ";", 
  RowBox[{"ScalHeadList", "=", 
   RowBox[{"{", "}"}]}], ";", 
  RowBox[{"nodHeads", "=", 
   RowBox[{"{", 
    RowBox[{
    "Bar", ",", "Pattern", ",", "Condition", ",", "RuleDelayed", ",", 
     "SeriesData"}], "}"}]}], ";", 
  RowBox[{"$EDCversion", "=", "360"}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"zeroQ", "[", "0", "]"}], "=", "True"}], ";", 
  RowBox[{
   RowBox[{"zeroQ", "[", "x_List", "]"}], ":=", 
   RowBox[{"And", "@@", 
    RowBox[{"(", 
     RowBox[{"zeroQ", "/@", 
      RowBox[{"Union", "[", 
       RowBox[{"Flatten", "[", "x", "]"}], "]"}]}], ")"}]}]}], ";", 
  RowBox[{
   RowBox[{"zeroQ", "[", "x_SeriesData", "]"}], ":=", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"x", "[", 
       RowBox[{"[", "3", "]"}], "]"}], "===", 
      RowBox[{"{", "}"}]}], ",", "True", ",", "False"}], "]"}]}], ";", 
  RowBox[{
   RowBox[{"zeroQ", "[", "x_", "]"}], ":=", "False"}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"Bar", ",", 
    RowBox[{"{", "Listable", "}"}]}], "]"}], ";", 
  RowBox[{
   RowBox[{"Bar", "[", 
    RowBox[{"Bar", "[", "x_", "]"}], "]"}], "=", "x"}], ";", 
  RowBox[{
   RowBox[{"Bar", "[", 
    RowBox[{"Complex", "[", 
     RowBox[{"u_", ",", "v_"}], "]"}], "]"}], ":=", 
   RowBox[{"Complex", "[", 
    RowBox[{"u", ",", 
     RowBox[{"-", "v"}]}], "]"}]}], ";", 
  RowBox[{
   RowBox[{"Bar", "[", 
    RowBox[{
    "x_Plus", "|", "x_Times", "|", "x_Wedge", "|", "x_Power", "|", "x_Rule", 
     "|", "x_Equal"}], "]"}], ":=", 
   RowBox[{"Bar", "/@", "x"}]}], ";", 
  RowBox[{
   RowBox[{"Bar", "[", "x_SeriesData", "]"}], ":=", 
   RowBox[{"x", "/.", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{
       RowBox[{"First", "[", "x", "]"}], "->", 
       RowBox[{"Bar", "[", 
        RowBox[{"First", "[", "x", "]"}], "]"}]}], ",", 
      RowBox[{
       RowBox[{"x", "[", 
        RowBox[{"[", "2", "]"}], "]"}], "->", 
       RowBox[{"Bar", "[", 
        RowBox[{"x", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "]"}]}], ",", 
      RowBox[{
       RowBox[{"x", "[", 
        RowBox[{"[", "3", "]"}], "]"}], "->", 
       RowBox[{"Bar", "/@", 
        RowBox[{"x", "[", 
         RowBox[{"[", "3", "]"}], "]"}]}]}]}], "}"}]}]}], ";", 
  RowBox[{
   RowBox[{"Bar", "[", 
    RowBox[{"DirectedInfinity", "[", "x_", "]"}], "]"}], ":=", 
   RowBox[{"DirectedInfinity", "[", 
    RowBox[{"Bar", "[", "x", "]"}], "]"}]}], ";", 
  RowBox[{
   RowBox[{"Bar", "[", 
    RowBox[{"d", "[", "x_", "]"}], "]"}], ":=", 
   RowBox[{"d", "[", 
    RowBox[{"Bar", "[", "x", "]"}], "]"}]}], ";", 
  RowBox[{
   RowBox[{"Bar", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Derivative", "[", "x__", "]"}], "[", "y_", "]"}], "[", "z__", 
     "]"}], "]"}], ":=", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Union", "[", 
       RowBox[{"Bar", "[", 
        RowBox[{"{", "z", "}"}], "]"}], "]"}], "===", 
      RowBox[{"Union", "[", 
       RowBox[{"{", "z", "}"}], "]"}]}], ",", 
     RowBox[{
      RowBox[{
       RowBox[{"Derivative", "[", 
        RowBox[{"Sequence", "@@", 
         RowBox[{
          RowBox[{"Permutations", "[", 
           RowBox[{"{", "x", "}"}], "]"}], "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"Position", "[", 
             RowBox[{
              RowBox[{"Permutations", "[", 
               RowBox[{"{", "z", "}"}], "]"}], ",", 
              RowBox[{"Bar", "[", 
               RowBox[{"{", "z", "}"}], "]"}]}], "]"}], "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}], "]"}]}], "]"}], 
       "[", 
       RowBox[{"Bar", "[", "y", "]"}], "]"}], "[", "z", "]"}], ",", 
     RowBox[{
      RowBox[{
       RowBox[{"Derivative", "[", "x", "]"}], "[", 
       RowBox[{"Bar", "[", "y", "]"}], "]"}], "[", 
      RowBox[{"Sequence", "@@", 
       RowBox[{"Bar", "[", 
        RowBox[{"{", "z", "}"}], "]"}]}], "]"}]}], "]"}]}], ";", 
  RowBox[{
   RowBox[{"Bar", "[", "x_", "]"}], ":=", 
   RowBox[{"x", "/;", 
    RowBox[{"NumericQ", "[", "x", "]"}]}]}], ";"}]], "Input"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"FormDegree", "[", "x_Plus", "]"}], ":=", 
   RowBox[{"FormDegree", "[", 
    RowBox[{"First", "[", "x", "]"}], "]"}]}], ";", 
  RowBox[{
   RowBox[{"FormDegree", "[", "x_Times", "]"}], ":=", 
   RowBox[{"Plus", "@@", 
    RowBox[{"FormDegree", "/@", 
     RowBox[{"List", "@@", "x"}]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FormDegree", "[", "x_Wedge", "]"}], ":=", 
   RowBox[{"Plus", "@@", 
    RowBox[{"FormDegree", "/@", 
     RowBox[{"List", "@@", "x"}]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FormDegree", "[", 
    RowBox[{"d", "[", "x_", "]"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"FormDegree", "[", 
     RowBox[{"d", "[", "x", "]"}], "]"}], "=", 
    RowBox[{"1", "+", 
     RowBox[{"FormDegree", "[", "x", "]"}]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FormDegree", "[", "x_List", "]"}], ":=", 
   RowBox[{"FormDegree", "[", 
    RowBox[{"First", "[", 
     RowBox[{"Select", "[", 
      RowBox[{
       RowBox[{"Union", "[", 
        RowBox[{"Flatten", "[", "x", "]"}], "]"}], ",", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{"zeroQ", "[", "#", "]"}]}], "&"}]}], "]"}], "]"}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FormDegree", "[", 
    RowBox[{"Bar", "[", "x_", "]"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"FormDegree", "[", 
     RowBox[{"Bar", "[", "x", "]"}], "]"}], "=", 
    RowBox[{"FormDegree", "[", "x", "]"}]}]}], ";", 
  RowBox[{
   RowBox[{"FormDegree", "[", "x_SeriesData", "]"}], ":=", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"x", "[", 
       RowBox[{"[", "3", "]"}], "]"}], "===", 
      RowBox[{"{", "}"}]}], ",", "0", ",", 
     RowBox[{"FormDegree", "[", 
      RowBox[{"x", "[", 
       RowBox[{"[", "3", "]"}], "]"}], "]"}]}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FormDegree", "[", "x_", "]"}], ":=", "0"}], ";"}]}], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DeclareForms", "[", "z__", "]"}], ":=", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"h", ",", 
       RowBox[{"x", "=", 
        RowBox[{"{", 
         RowBox[{"{", "z", "}"}], "}"}]}], ",", "xi", ",", "rxi", ",", "k", 
       ",", "oldHeads", ",", "newHeads"}], "}"}], ",", 
     RowBox[{
      RowBox[{"While", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Head", "[", 
          RowBox[{"x", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}], "===", "List"}], 
        ",", 
        RowBox[{"x", "=", 
         RowBox[{"First", "[", "x", "]"}]}]}], "]"}], ";", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"xi", "=", 
          RowBox[{"x", "[", 
           RowBox[{"[", "i", "]"}], "]"}]}], ";", 
         RowBox[{"rxi", "=", 
          RowBox[{"Rest", "[", "xi", "]"}]}], ";", 
         RowBox[{
          RowBox[{"Forms", "[", 
           RowBox[{"First", "[", "xi", "]"}], "]"}], "=", 
          RowBox[{"Union", "[", 
           RowBox[{
            RowBox[{"Forms", "[", 
             RowBox[{"First", "[", "xi", "]"}], "]"}], ",", "rxi"}], "]"}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"AllScalForms", "=", 
          RowBox[{"Union", "[", 
           RowBox[{"AllScalForms", ",", "rxi"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"Do", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"h", "=", 
             RowBox[{"Head", "[", 
              RowBox[{"rxi", "[", 
               RowBox[{"[", "j", "]"}], "]"}], "]"}]}], ";", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"h", "===", "Symbol"}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"FormDegree", "[", 
                 RowBox[{"rxi", "[", 
                  RowBox[{"[", "j", "]"}], "]"}], "]"}], "=", 
                RowBox[{"First", "[", "xi", "]"}]}], ";", 
               RowBox[{
                RowBox[{
                 RowBox[{"BasicScalFormQ", "[", 
                  RowBox[{"rxi", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "=", "True"}], 
                ";"}]}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"FormDegree", "[", "_h", "]"}], "=", 
                RowBox[{"First", "[", "xi", "]"}]}], ";", 
               RowBox[{
                RowBox[{"BasicScalFormQ", "[", "_h", "]"}], "=", "True"}], 
               ";"}]}], "]"}]}], ",", 
           RowBox[{"{", 
            RowBox[{"j", ",", 
             RowBox[{"Length", "[", "rxi", "]"}]}], "}"}]}], "]"}]}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Length", "[", "x", "]"}]}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"AllDifForms", "=", 
       RowBox[{"Union", "[", "AllScalForms", "]"}]}], ";", 
      RowBox[{"oldHeads", "=", "ScalHeadList"}], ";", 
      RowBox[{"ScalHeadList", "=", 
       RowBox[{"Complement", "[", 
        RowBox[{
         RowBox[{"Union", "[", 
          RowBox[{
           RowBox[{"Head", "/@", "AllScalForms"}], ",", "ScalHeadList"}], 
          "]"}], ",", 
         RowBox[{"{", "Symbol", "}"}]}], "]"}]}], ";", 
      RowBox[{"newHeads", "=", 
       RowBox[{"Complement", "[", 
        RowBox[{"ScalHeadList", ",", "oldHeads"}], "]"}]}], ";", 
      RowBox[{"AllSymbols", "=", 
       RowBox[{"Union", "[", "AllDifForms", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"HeadList", "=", 
       RowBox[{"Union", "[", 
        RowBox[{"Head", "/@", "AllSymbols"}], "]"}]}], ";", 
      RowBox[{"DifFormSymbols", "=", 
       RowBox[{"Drop", "[", 
        RowBox[{"AllDifForms", ",", 
         RowBox[{"-", 
          RowBox[{"Length", "[", "ScalHeadList", "]"}]}]}], "]"}]}], ";", 
      "\n", 
      RowBox[{"k", "=", 
       RowBox[{"Thread", "[", 
        RowBox[{"Blank", "[", "ScalHeadList", "]"}], "]"}]}], ";", 
      RowBox[{"FormVars", "=", 
       RowBox[{"Flatten", "[", 
        RowBox[{"{", 
         RowBox[{"_Wedge", ",", "_d", ",", 
          RowBox[{"Union", "[", 
           RowBox[{"k", ",", 
            RowBox[{"Bar", "[", "k", "]"}]}], "]"}], ",", 
          RowBox[{
           RowBox[{"u_", "|", 
            RowBox[{"Bar", "[", "u_", "]"}]}], "/;", 
           RowBox[{"MemberQ", "[", 
            RowBox[{"DifFormSymbols", ",", "u"}], "]"}]}], ",", "_tr"}], 
         "}"}], "]"}]}], ";"}]}], "]"}]}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"NoDif", "[", "z__", "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{
    RowBox[{"nodHeads", "=", 
     RowBox[{"Union", "[", 
      RowBox[{"nodHeads", ",", 
       RowBox[{"Flatten", "[", 
        RowBox[{"{", "z", "}"}], "]"}]}], "]"}]}], ";"}], ")"}]}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"BasicScalFormQ", "[", 
    RowBox[{"Bar", "[", "x_", "]"}], "]"}], ":=", 
   RowBox[{"BasicScalFormQ", "[", "x", "]"}]}], ";", 
  RowBox[{
   RowBox[{"BasicScalFormQ", "[", "_d", "]"}], "=", "True"}], ";", 
  RowBox[{
   RowBox[{"BasicScalFormQ", "[", "x_", "]"}], ":=", "False"}], 
  ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"ScalFormQ", "[", "x_Times", "]"}], ":=", 
   RowBox[{"Or", "@@", 
    RowBox[{"ScalFormQ", "/@", 
     RowBox[{"List", "@@", "x"}]}]}]}], ";", 
  RowBox[{
   RowBox[{"ScalFormQ", "[", 
    RowBox[{"x_Wedge", "|", "x_Plus"}], "]"}], ":=", 
   RowBox[{"And", "@@", 
    RowBox[{"ScalFormQ", "/@", 
     RowBox[{"List", "@@", "x"}]}]}]}], ";", 
  RowBox[{
   RowBox[{"ScalFormQ", "[", "x_", "]"}], ":=", 
   RowBox[{"BasicScalFormQ", "[", "x", "]"}]}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"d", ",", 
    RowBox[{"{", "Listable", "}"}]}], "]"}], ";", 
  RowBox[{
   RowBox[{"d", "[", 
    RowBox[{"x_Times", "|", "x_Wedge"}], "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"d", "[", 
      RowBox[{"First", "[", "x", "]"}], "]"}], "\[Wedge]", 
     RowBox[{"Rest", "[", "x", "]"}]}], "+", 
    RowBox[{
     RowBox[{
      RowBox[{"(", 
       RowBox[{"-", "1"}], ")"}], "^", 
      RowBox[{"FormDegree", "[", 
       RowBox[{"First", "[", "x", "]"}], "]"}]}], "*", 
     RowBox[{
      RowBox[{"First", "[", "x", "]"}], "\[Wedge]", 
      RowBox[{"d", "[", 
       RowBox[{"Rest", "[", "x", "]"}], "]"}]}]}]}]}], ";", 
  RowBox[{
   RowBox[{"d", "[", 
    RowBox[{
     RowBox[{"x_", "?", "NumericQ"}], "|", "x_d"}], "]"}], "=", "0"}], ";", 
  RowBox[{
   RowBox[{"d", "[", 
    RowBox[{"Power", "[", 
     RowBox[{"y_", ",", "n_"}], "]"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"n", " ", 
     RowBox[{"y", "^", 
      RowBox[{"(", 
       RowBox[{"n", "-", "1"}], ")"}]}], " ", 
     RowBox[{"d", "[", "y", "]"}]}], "+", 
    RowBox[{
     RowBox[{"y", "^", "n"}], " ", 
     RowBox[{"Log", "[", "y", "]"}], 
     RowBox[{"d", "[", "n", "]"}]}]}]}], ";", 
  RowBox[{
   RowBox[{"d", "[", "x_Plus", "]"}], ":=", 
   RowBox[{"d", "/@", "x"}]}], ";", 
  RowBox[{
   RowBox[{"HoldPattern", "[", 
    RowBox[{"d", "[", 
     RowBox[{"Bar", "[", "x_", "]"}], "]"}], "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"evalHx", "=", 
       RowBox[{"d", "[", "x", "]"}]}], "}"}], ",", 
     RowBox[{
      RowBox[{"Bar", "[", "evalHx", "]"}], "/;", 
      RowBox[{
       RowBox[{"Head", "[", "evalHx", "]"}], "=!=", "d"}]}]}], "]"}]}], ";", 
  RowBox[{
   RowBox[{"d", "[", 
    RowBox[{"x_Rule", "|", "x_Equal"}], "]"}], ":=", 
   RowBox[{"reWrite", "[", 
    RowBox[{"d", "/@", "x"}], "]"}]}], ";", 
  RowBox[{
   RowBox[{"d", "[", "x_SeriesData", "]"}], ":=", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{"x", "/.", 
      RowBox[{
       RowBox[{"x", "[", 
        RowBox[{"[", "3", "]"}], "]"}], "->", 
       RowBox[{"d", "[", 
        RowBox[{"x", "[", 
         RowBox[{"[", "3", "]"}], "]"}], "]"}]}]}], ")"}], "+", 
    RowBox[{"Wedge", "[", 
     RowBox[{
      RowBox[{"d", "[", 
       RowBox[{"First", "[", "x", "]"}], "]"}], ",", 
      RowBox[{"D", "[", 
       RowBox[{"x", ",", 
        RowBox[{"First", "[", "x", "]"}]}], "]"}]}], "]"}]}]}], ";", 
  RowBox[{
   RowBox[{"d", "[", 
    RowBox[{
     RowBox[{"h_", "[", "y__", "]"}], "/;", 
     RowBox[{"!", 
      RowBox[{"MemberQ", "[", 
       RowBox[{"nodHeads", ",", "h"}], "]"}]}]}], "]"}], ":=", 
   RowBox[{
    RowBox[{"Sum", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"Derivative", "[", 
           RowBox[{"Sequence", "@@", 
            RowBox[{"RotateRight", "[", 
             RowBox[{
              RowBox[{"Append", "[", 
               RowBox[{
                RowBox[{"Table", "[", 
                 RowBox[{"0", ",", 
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"Length", "[", 
                    RowBox[{"{", "y", "}"}], "]"}], "-", "1"}], "}"}]}], 
                 "]"}], ",", "1"}], "]"}], ",", "i"}], "]"}]}], "]"}], "[", 
          "h", "]"}], "[", "y", "]"}], ")"}], 
       RowBox[{"d", "[", 
        RowBox[{
         RowBox[{"{", "y", "}"}], "[", 
         RowBox[{"[", "i", "]"}], "]"}], "]"}]}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", 
        RowBox[{"Length", "[", 
         RowBox[{"{", "y", "}"}], "]"}]}], "}"}]}], "]"}], "/;", 
    RowBox[{
     RowBox[{
      RowBox[{"FormDegree", "[", 
       RowBox[{"h", "[", "y", "]"}], "]"}], "===", "0"}], "&&", 
     RowBox[{"!", 
      RowBox[{"MemberQ", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"Integer", ",", "Blank", ",", "Pattern", ",", "Condition"}], 
         "}"}], ",", 
        RowBox[{"Head", "[", 
         RowBox[{"First", "[", 
          RowBox[{"{", "y", "}"}], "]"}], "]"}]}], "]"}]}]}]}]}], 
  ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"newSer$", "[", 
   RowBox[{"x_SeriesData", ",", "k_"}], "]"}], ":=", 
  RowBox[{"SeriesData", "[", 
   RowBox[{
    RowBox[{"First", "[", "x", "]"}], ",", 
    RowBox[{"x", "[", 
     RowBox[{"[", "2", "]"}], "]"}], ",", 
    RowBox[{"Flatten", "[", 
     RowBox[{"Transpose", "[", 
      RowBox[{"Prepend", "[", 
       RowBox[{
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"Table", "[", 
           RowBox[{"0", ",", 
            RowBox[{"{", 
             RowBox[{"Length", "[", 
              RowBox[{"x", "[", 
               RowBox[{"[", "3", "]"}], "]"}], "]"}], "}"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"k", "-", "1"}], "}"}]}], "]"}], ",", 
        RowBox[{"x", "[", 
         RowBox[{"[", "3", "]"}], "]"}]}], "]"}], "]"}], "]"}], ",", 
    RowBox[{"k", " ", 
     RowBox[{"x", "[", 
      RowBox[{"[", "4", "]"}], "]"}]}], ",", 
    RowBox[{"k", " ", 
     RowBox[{"x", "[", 
      RowBox[{"[", "5", "]"}], "]"}]}], ",", 
    RowBox[{"k", " ", 
     RowBox[{"Last", "[", "x", "]"}]}]}], "]"}]}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"Wedge", "[", "x_", "]"}], ":=", 
  RowBox[{"x", "/;", 
   RowBox[{
    RowBox[{
     RowBox[{"Length", "[", 
      RowBox[{"{", "x", "}"}], "]"}], "<", "2"}], "&&", 
    RowBox[{
     RowBox[{"Head", "[", 
      RowBox[{
       RowBox[{"{", "x", "}"}], "[", 
       RowBox[{"[", "1", "]"}], "]"}], "]"}], "=!=", 
     "Pattern"}]}]}]}]], "Input"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Default", "[", "Wedge", "]"}], ":=", "1"}], ";", 
  RowBox[{"SetAttributes", "[", 
   RowBox[{"Wedge", ",", 
    RowBox[{"{", 
     RowBox[{"Flat", ",", "OneIdentity"}], "}"}]}], "]"}], ";", 
  RowBox[{
   RowBox[{"Wedge", "[", 
    RowBox[{"0", ",", "y__"}], "]"}], "=", "0"}], ";", 
  RowBox[{
   RowBox[{"Wedge", "[", 
    RowBox[{"x__", ",", "0"}], "]"}], "=", "0"}], ";", 
  RowBox[{
   RowBox[{"Wedge", "[", 
    RowBox[{"x_SeriesData", ",", "y_SeriesData"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "x$", ",", "y$", ",", "r1", ",", "r2", ",", "res", ",", "x3", ",", 
        "y3"}], "}"}], ",", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Last", "[", "x", "]"}], "===", 
          RowBox[{"Last", "[", "y", "]"}]}], ",", 
         RowBox[{
          RowBox[{"x$", "=", "x"}], ";", 
          RowBox[{"y$", "=", "y"}]}], ",", 
         RowBox[{
          RowBox[{"x$", "=", 
           RowBox[{"newSer$", "[", 
            RowBox[{"x", ",", 
             RowBox[{
              RowBox[{"LCM", "[", 
               RowBox[{
                RowBox[{"Last", "[", "x", "]"}], ",", 
                RowBox[{"Last", "[", "y", "]"}]}], "]"}], "/", 
              RowBox[{"Last", "[", "x", "]"}]}]}], "]"}]}], ";", 
          RowBox[{"y$", "=", 
           RowBox[{"newSer$", "[", 
            RowBox[{"y", ",", 
             RowBox[{
              RowBox[{"LCM", "[", 
               RowBox[{
                RowBox[{"Last", "[", "x", "]"}], ",", 
                RowBox[{"Last", "[", "y", "]"}]}], "]"}], "/", 
              RowBox[{"Last", "[", "y", "]"}]}]}], "]"}]}]}]}], "]"}], ";", 
       RowBox[{"r1", "=", 
        RowBox[{
         RowBox[{"x$", "[", 
          RowBox[{"[", 
           RowBox[{"-", "3"}], "]"}], "]"}], "+", 
         RowBox[{"y$", "[", 
          RowBox[{"[", 
           RowBox[{"-", "3"}], "]"}], "]"}]}]}], ";", 
       RowBox[{"r2", "=", 
        RowBox[{"Min", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"x$", "[", 
            RowBox[{"[", 
             RowBox[{"-", "2"}], "]"}], "]"}], "+", 
           RowBox[{"y$", "[", 
            RowBox[{"[", 
             RowBox[{"-", "3"}], "]"}], "]"}]}], ",", 
          RowBox[{
           RowBox[{"x$", "[", 
            RowBox[{"[", 
             RowBox[{"-", "3"}], "]"}], "]"}], "+", 
           RowBox[{"y$", "[", 
            RowBox[{"[", 
             RowBox[{"-", "2"}], "]"}], "]"}]}]}], "]"}]}], ";", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Length", "[", 
           RowBox[{"x$", "[", 
            RowBox[{"[", "3", "]"}], "]"}], "]"}], "<", 
          RowBox[{
           RowBox[{"x$", "[", 
            RowBox[{"[", 
             RowBox[{"-", "2"}], "]"}], "]"}], "-", 
           RowBox[{"x$", "[", 
            RowBox[{"[", 
             RowBox[{"-", "3"}], "]"}], "]"}]}]}], ",", 
         RowBox[{"x3", "=", 
          RowBox[{"Join", "[", 
           RowBox[{
            RowBox[{"x$", "[", 
             RowBox[{"[", "3", "]"}], "]"}], ",", 
            RowBox[{"Table", "[", 
             RowBox[{"0", ",", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"x$", "[", 
                 RowBox[{"[", 
                  RowBox[{"-", "2"}], "]"}], "]"}], "-", 
                RowBox[{"x$", "[", 
                 RowBox[{"[", 
                  RowBox[{"-", "3"}], "]"}], "]"}], "-", 
                RowBox[{"Length", "[", 
                 RowBox[{"x$", "[", 
                  RowBox[{"[", "3", "]"}], "]"}], "]"}]}], "}"}]}], "]"}]}], 
           "]"}]}], ",", 
         RowBox[{"x3", "=", 
          RowBox[{"x$", "[", 
           RowBox[{"[", "3", "]"}], "]"}]}]}], "]"}], ";", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Length", "[", 
           RowBox[{"y$", "[", 
            RowBox[{"[", "3", "]"}], "]"}], "]"}], "<", 
          RowBox[{
           RowBox[{"y$", "[", 
            RowBox[{"[", 
             RowBox[{"-", "2"}], "]"}], "]"}], "-", 
           RowBox[{"y$", "[", 
            RowBox[{"[", 
             RowBox[{"-", "3"}], "]"}], "]"}]}]}], ",", 
         RowBox[{"y3", "=", 
          RowBox[{"Join", "[", 
           RowBox[{
            RowBox[{"y$", "[", 
             RowBox[{"[", "3", "]"}], "]"}], ",", 
            RowBox[{"Table", "[", 
             RowBox[{"0", ",", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"y$", "[", 
                 RowBox[{"[", 
                  RowBox[{"-", "2"}], "]"}], "]"}], "-", 
                RowBox[{"y$", "[", 
                 RowBox[{"[", 
                  RowBox[{"-", "3"}], "]"}], "]"}], "-", 
                RowBox[{"Length", "[", 
                 RowBox[{"y$", "[", 
                  RowBox[{"[", "3", "]"}], "]"}], "]"}]}], "}"}]}], "]"}]}], 
           "]"}]}], ",", 
         RowBox[{"y3", "=", 
          RowBox[{"y$", "[", 
           RowBox[{"[", "3", "]"}], "]"}]}]}], "]"}], ";", 
       RowBox[{"Which", "[", 
        RowBox[{
         RowBox[{"r2", "===", "r1"}], ",", 
         RowBox[{"res", "=", 
          RowBox[{"{", "}"}]}], ",", 
         RowBox[{
          RowBox[{"r2", "-", "r1"}], "===", 
          RowBox[{
           RowBox[{"x$", "[", 
            RowBox[{"[", 
             RowBox[{"-", "2"}], "]"}], "]"}], "-", 
           RowBox[{"x$", "[", 
            RowBox[{"[", 
             RowBox[{"-", "3"}], "]"}], "]"}]}]}], ",", 
         RowBox[{"res", "=", 
          RowBox[{"Sum", "[", 
           RowBox[{
            RowBox[{"Map", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Wedge", "[", 
                RowBox[{
                 RowBox[{"x3", "[", 
                  RowBox[{"[", "i", "]"}], "]"}], ",", "#"}], "]"}], "&"}], 
              ",", 
              RowBox[{"Join", "[", 
               RowBox[{
                RowBox[{"Table", "[", 
                 RowBox[{"0", ",", 
                  RowBox[{"{", 
                   RowBox[{"i", "-", "1"}], "}"}]}], "]"}], ",", 
                RowBox[{"Drop", "[", 
                 RowBox[{"y3", ",", 
                  RowBox[{
                   RowBox[{"-", "i"}], "+", "1"}]}], "]"}]}], "]"}]}], "]"}], 
            ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", 
              RowBox[{"Length", "[", "x3", "]"}]}], "}"}]}], "]"}]}], ",", 
         "True", ",", 
         RowBox[{"res", "=", 
          RowBox[{"Sum", "[", 
           RowBox[{
            RowBox[{"Map", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Wedge", "[", 
                RowBox[{"#", ",", 
                 RowBox[{"y3", "[", 
                  RowBox[{"[", "i", "]"}], "]"}]}], "]"}], "&"}], ",", 
              RowBox[{"Join", "[", 
               RowBox[{
                RowBox[{"Table", "[", 
                 RowBox[{"0", ",", 
                  RowBox[{"{", 
                   RowBox[{"i", "-", "1"}], "}"}]}], "]"}], ",", 
                RowBox[{"Drop", "[", 
                 RowBox[{"x3", ",", 
                  RowBox[{
                   RowBox[{"-", "i"}], "+", "1"}]}], "]"}]}], "]"}]}], "]"}], 
            ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", 
              RowBox[{"Length", "[", "y3", "]"}]}], "}"}]}], "]"}]}]}], "]"}],
        ";", 
       RowBox[{"SeriesData", "[", 
        RowBox[{
         RowBox[{"First", "[", "x$", "]"}], ",", 
         RowBox[{"x$", "[", 
          RowBox[{"[", "2", "]"}], "]"}], ",", "res", ",", "r1", ",", "r2", 
         ",", 
         RowBox[{"Last", "[", "x$", "]"}]}], "]"}]}]}], "]"}], "/;", 
    RowBox[{
     RowBox[{
      RowBox[{"First", "[", "x", "]"}], "===", 
      RowBox[{"First", "[", "y", "]"}]}], "&&", 
     RowBox[{
      RowBox[{"x", "[", 
       RowBox[{"[", "2", "]"}], "]"}], "===", 
      RowBox[{"y", "[", 
       RowBox[{"[", "2", "]"}], "]"}]}]}]}]}], ";", 
  RowBox[{
   RowBox[{"Wedge", "[", 
    RowBox[{"y_", ",", "x_SeriesData"}], "]"}], ":=", 
   RowBox[{"x", "/.", 
    RowBox[{
     RowBox[{"x", "[", 
      RowBox[{"[", "3", "]"}], "]"}], "->", 
     RowBox[{"Map", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Wedge", "[", 
         RowBox[{"y", ",", "#"}], "]"}], "&"}], ",", 
       RowBox[{"x", "[", 
        RowBox[{"[", "3", "]"}], "]"}]}], "]"}]}]}]}], ";", 
  RowBox[{
   RowBox[{"Wedge", "[", 
    RowBox[{"x_SeriesData", ",", "y_"}], "]"}], ":=", 
   RowBox[{"x", "/.", 
    RowBox[{
     RowBox[{"x", "[", 
      RowBox[{"[", "3", "]"}], "]"}], "->", 
     RowBox[{"Map", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Wedge", "[", 
         RowBox[{"#", ",", "y"}], "]"}], "&"}], ",", 
       RowBox[{"x", "[", 
        RowBox[{"[", "3", "]"}], "]"}]}], "]"}]}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Wedge", "[", 
    RowBox[{"x__", ",", "y_Plus"}], "]"}], ":=", 
   RowBox[{"Plus", "@@", 
    RowBox[{"Map", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Wedge", "[", 
        RowBox[{"x", ",", "#"}], "]"}], "&"}], ",", 
      RowBox[{"List", "@@", "y"}]}], "]"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Wedge", "[", 
    RowBox[{"x_Plus", ",", "y__"}], "]"}], ":=", 
   RowBox[{"Plus", "@@", 
    RowBox[{"Map", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Wedge", "[", 
        RowBox[{"#", ",", "y"}], "]"}], "&"}], ",", 
      RowBox[{"List", "@@", "x"}]}], "]"}]}]}], ";", 
  RowBox[{
   RowBox[{"Wedge", "[", 
    RowBox[{"u__", ",", 
     RowBox[{"Times", "[", 
      RowBox[{"x_", ",", "y_"}], "]"}]}], "]"}], ":=", 
   RowBox[{
    RowBox[{"Times", "[", 
     RowBox[{"x", ",", 
      RowBox[{"Wedge", "[", 
       RowBox[{"u", ",", "y"}], "]"}]}], "]"}], "/;", 
    RowBox[{
     RowBox[{"NumericQ", "[", "x", "]"}], "||", 
     RowBox[{
      RowBox[{"FormDegree", "[", "x", "]"}], "===", "0"}]}]}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Wedge", "[", 
    RowBox[{
     RowBox[{"Times", "[", 
      RowBox[{"x_", ",", "y_"}], "]"}], ",", "z__"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"Times", "[", 
     RowBox[{"x", ",", 
      RowBox[{"Wedge", "[", 
       RowBox[{"y", ",", "z"}], "]"}]}], "]"}], "/;", 
    RowBox[{
     RowBox[{"NumericQ", "[", "x", "]"}], "||", 
     RowBox[{
      RowBox[{"FormDegree", "[", "x", "]"}], "===", "0"}]}]}]}], ";", 
  RowBox[{
   RowBox[{
    RowBox[{"x_", "^", "n_."}], "\[Wedge]", "y_"}], " ", ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"x", "^", "n"}], "*", "y"}], "/;", 
    RowBox[{
     RowBox[{"FormDegree", "[", "x", "]"}], "===", "0"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"y_", "\[Wedge]", 
    RowBox[{"x_", "^", "n_."}]}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"x", "^", "n"}], "*", "y"}], "/;", 
    RowBox[{
     RowBox[{"FormDegree", "[", "x", "]"}], "===", "0"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"Wedge", "[", 
    RowBox[{"x_", ",", "y___", ",", "x_"}], "]"}], ":=", 
   RowBox[{"0", "/;", 
    RowBox[{
     RowBox[{"OddQ", "[", 
      RowBox[{"FormDegree", "[", "x", "]"}], "]"}], "&&", 
     RowBox[{"ScalFormQ", "[", "x", "]"}]}]}]}], ";", 
  RowBox[{
   RowBox[{"Wedge", "[", "x__", "]"}], ":=", 
   RowBox[{
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"doubL", "=", 
        RowBox[{"Transpose", "[", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"FormDegree", "/@", 
            RowBox[{"{", "x", "}"}]}], ",", 
           RowBox[{"{", "x", "}"}]}], "}"}], "]"}]}], "}"}], ",", 
      RowBox[{
       RowBox[{"Signature", "[", 
        RowBox[{"Select", "[", 
         RowBox[{"doubL", ",", 
          RowBox[{
           RowBox[{"OddQ", "[", 
            RowBox[{"First", "[", "#", "]"}], "]"}], "&"}]}], "]"}], "]"}], 
       RowBox[{"Wedge", "@@", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Last", "[", "#1", "]"}], "&"}], ",", 
          RowBox[{"Sort", "[", "doubL", "]"}]}], "]"}]}]}]}], "]"}], "/;", 
    RowBox[{
     RowBox[{
      RowBox[{"Union", "[", 
       RowBox[{"BasicScalFormQ", "/@", 
        RowBox[{"{", "x", "}"}]}], "]"}], "===", 
      RowBox[{"{", "True", "}"}]}], "&&", 
     RowBox[{
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Last", "[", "#1", "]"}], "&"}], ",", 
        RowBox[{"Sort", "[", 
         RowBox[{"Transpose", "[", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"FormDegree", "/@", 
             RowBox[{"{", "x", "}"}]}], ",", 
            RowBox[{"{", "x", "}"}]}], "}"}], "]"}], "]"}]}], "]"}], "=!=", 
      RowBox[{"{", "x", "}"}]}]}]}]}], ";"}]}], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"simpRules", " ", "=", " ", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"Cos", "[", "z_", "]"}], "^", "2"}], "*", 
       RowBox[{"(", "x_.", ")"}]}], "+", 
      RowBox[{
       RowBox[{"(", "x_.", ")"}], "*", 
       RowBox[{
        RowBox[{"Sin", "[", "z_", "]"}], "^", "2"}]}]}], " ", "->", " ", 
     "x"}], "}"}]}], ";", 
  RowBox[{"varList", "=", 
   RowBox[{"{", "}"}]}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"coll", "[", "x_", "]"}], ":=", 
   RowBox[{"Collect", "[", 
    RowBox[{"x", ",", 
     RowBox[{"{", 
      RowBox[{"_Wedge", ",", "_tr"}], "}"}], ",", "Factor"}], "]"}]}], 
  ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"reWrite", ",", 
    RowBox[{"{", "Listable", "}"}]}], "]"}], ";", 
  RowBox[{
   RowBox[{"reWrite", "[", "0", "]"}], "=", "0"}], ";", 
  RowBox[{
   RowBox[{"reWrite", "[", "x_Equal", "]"}], ":=", 
   RowBox[{"Equal", "[", 
    RowBox[{
     RowBox[{"reWrite", "[", 
      RowBox[{
       RowBox[{"First", "[", "x", "]"}], "-", 
       RowBox[{"Last", "[", "x", "]"}]}], "]"}], ",", "0"}], "]"}]}], ";", 
  RowBox[{
   RowBox[{"reWrite", "[", "x_Rule", "]"}], ":=", 
   RowBox[{"Rule", "[", 
    RowBox[{
     RowBox[{"First", "[", "x", "]"}], ",", 
     RowBox[{"reWrite", "[", 
      RowBox[{"Last", "[", "x", "]"}], "]"}]}], "]"}]}], ";", 
  RowBox[{
   RowBox[{"reWrite", "[", "x_SeriesData", "]"}], ":=", 
   RowBox[{"(", 
    RowBox[{"x", "/.", 
     RowBox[{
      RowBox[{"x", "[", 
       RowBox[{"[", "3", "]"}], "]"}], "->", 
      RowBox[{"reWrite", "[", 
       RowBox[{"x", "[", 
        RowBox[{"[", "3", "]"}], "]"}], "]"}]}]}], ")"}]}], ";", 
  RowBox[{
   RowBox[{"reWrite", "[", "x_", "]"}], ":=", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{"Collect", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"coll", "[", "x", "]"}], "/.", "simpRules"}], ",", 
        "FormVars", ",", "bestFacRul"}], "]"}], "/.", "simpRules"}], ")"}], "/;", 
    RowBox[{
     RowBox[{"FormDegree", "[", "x", "]"}], ">", "0"}]}]}], ";", 
  RowBox[{
   RowBox[{"reWrite", "[", "x_", "]"}], ":=", 
   RowBox[{
    RowBox[{"bestFacRul", "[", 
     RowBox[{"x", "/.", "simpRules"}], "]"}], "/.", "simpRules"}]}], 
  ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FreeALLQ", "[", 
    RowBox[{"x_", ",", "y_List"}], "]"}], ":=", 
   RowBox[{"And", "@@", 
    RowBox[{"Map", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"FreeQ", "[", 
        RowBox[{"x", ",", "#"}], "]"}], "&"}], ",", "y"}], "]"}]}]}], 
  ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"bestFacRul", "[", "x_", "]"}], ":=", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"varList", "===", 
       RowBox[{"{", "}"}]}], "||", 
      RowBox[{"FreeALLQ", "[", 
       RowBox[{"x", ",", "varList"}], "]"}]}], ",", 
     RowBox[{"minFacRul", "[", "x", "]"}], ",", 
     RowBox[{"varFacRul", "[", "x", "]"}]}], "]"}]}], ";", 
  RowBox[{
   RowBox[{"varFacRul", "[", "x_", "]"}], ":=", 
   RowBox[{
    RowBox[{"Collect", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Expand", "[", "x", "]"}], "/.", "simpRules"}], ",", "varList",
       ",", "Factor"}], "]"}], "/.", "simpRules"}]}], ";", 
  RowBox[{
   RowBox[{"minFacRul", "[", "x_", "]"}], ":=", 
   RowBox[{
    RowBox[{"Factor", "[", 
     RowBox[{
      RowBox[{"Expand", "[", "x", "]"}], "/.", "simpRules"}], "]"}], "/.", 
    "simpRules"}]}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"Unprotect", "[", "SeriesData", "]"}], ";", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"$VersionNumber", "<", "5"}], ",", 
    RowBox[{
     RowBox[{"Times", "[", 
      RowBox[{"x_SeriesData", ",", "0"}], "]"}], "^=", "0"}]}], "]"}], ";", 
  RowBox[{
   RowBox[{"SeriesData", "[", 
    RowBox[{
    "x1_", ",", "x2_", ",", "x3_", ",", "x4_", ",", "x5_", ",", "x6_"}], 
    "]"}], ":=", " ", 
   RowBox[{
    RowBox[{"Plus", "@@", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"x2", "===", "Infinity"}], ",", 
       RowBox[{
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"First", "[", "#", "]"}], "/", 
            RowBox[{"x1", "^", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{"x4", "+", 
                 RowBox[{"Last", "[", "#", "]"}], "-", "1"}], ")"}], "/", 
               "x6"}], ")"}]}]}], "&"}], ",", 
          RowBox[{"Transpose", "[", 
           RowBox[{"{", 
            RowBox[{"x3", ",", 
             RowBox[{"Range", "[", 
              RowBox[{"Length", "[", "x3", "]"}], "]"}]}], "}"}], "]"}]}], 
         "]"}], "+", 
        RowBox[{"SeriesData", "[", 
         RowBox[{"x1", ",", "x2", ",", 
          RowBox[{"{", "}"}], ",", "x4", ",", "x5", ",", "x6"}], "]"}]}], ",",
        "   ", 
       RowBox[{
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"First", "[", "#", "]"}], "*", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"x1", "-", "x2"}], ")"}], "^", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{"x4", "+", 
                 RowBox[{"Last", "[", "#", "]"}], "-", "1"}], ")"}], "/", 
               "x6"}], ")"}]}]}], "&"}], ",", 
          RowBox[{"Transpose", "[", 
           RowBox[{"{", 
            RowBox[{"x3", ",", 
             RowBox[{"Range", "[", 
              RowBox[{"Length", "[", "x3", "]"}], "]"}]}], "}"}], "]"}]}], 
         "]"}], "+", 
        RowBox[{"SeriesData", "[", 
         RowBox[{"x1", ",", "x2", ",", 
          RowBox[{"{", "}"}], ",", "x4", ",", "x5", ",", "x6"}], "]"}]}]}], 
      "]"}]}], "/;", 
    RowBox[{"!", 
     RowBox[{"FreeQ", "[", 
      RowBox[{"x3", ",", "x1"}], "]"}]}]}]}], ";", 
  RowBox[{"Protect", "[", "SeriesData", "]"}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"On", "[", 
   RowBox[{
    RowBox[{"General", "::", "\"\<spell\>\""}], ",", 
    RowBox[{"General", "::", "\"\<spell1\>\""}], ",", 
    RowBox[{"UpSet", "::", "\"\<write\>\""}]}], "]"}], ";"}]], "Input"]
}, Open  ]]
}, Open  ]]
},
CellGrouping->Manual,
WindowSize->{956, 721},
WindowMargins->{{12, Automatic}, {-80, Automatic}},
FrontEndVersion->"8.0 for Mac OS X x86 (32-bit, 64-bit Kernel) (October 5, \
2011)",
StyleDefinitions->"Default.nb",
MacintoshSystemPageSetup -> \
"0040001804P000000aP2I0000003609To`83609T0@00001804P000000aP2I001\n\
0@00I00100000@0200000BL?00400000000000000000051`I6H0I00000000000\n\
00000000000000000000000000000000"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[579, 22, 148, 5, 38, "Text"],
Cell[730, 29, 89, 2, 28, "Text"],
Cell[CellGroupData[{
Cell[844, 35, 313, 7, 49, "Text"],
Cell[1160, 44, 292, 7, 27, "Input"],
Cell[1455, 53, 562, 13, 58, "Input"],
Cell[2020, 68, 734, 23, 58, "Input"],
Cell[2757, 93, 665, 20, 43, "Input"],
Cell[3425, 115, 3149, 95, 135, "Input"],
Cell[6577, 212, 1928, 60, 103, "Input"],
Cell[8508, 274, 4528, 120, 150, "Input"],
Cell[13039, 396, 295, 9, 27, "Input"],
Cell[13337, 407, 348, 10, 27, "Input"],
Cell[13688, 419, 513, 15, 44, "Input"],
Cell[14204, 436, 4130, 129, 121, "Input"],
Cell[18337, 567, 1097, 32, 43, "Input"],
Cell[19437, 601, 381, 13, 27, "Input"],
Cell[19821, 616, 12712, 378, 268, "Input"],
Cell[32536, 996, 479, 16, 27, "Input"],
Cell[33018, 1014, 239, 8, 27, "Input"],
Cell[33260, 1024, 1616, 49, 73, "Input"],
Cell[34879, 1075, 311, 11, 27, "Input"],
Cell[35193, 1088, 894, 27, 58, "Input"],
Cell[36090, 1117, 2437, 70, 88, "Input"],
Cell[38530, 1189, 238, 6, 27, "Input"]
}, Open  ]]
}, Open  ]]
}
]
*)

(* End of internal cache information *)

