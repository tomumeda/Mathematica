(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     66868,       1828]
NotebookOptionsPosition[     64074,       1776]
NotebookOutlinePosition[     64465,       1793]
CellTagsIndexPosition[     64422,       1790]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell[BoxData[
 RowBox[{" ", 
  RowBox[{
   RowBox[{
    RowBox[{"tuIntegralSwitchVar0", "[", 
     RowBox[{"z", "\[Rule]", 
      RowBox[{"Exp", "[", "x", "]"}]}], "]"}], "[", 
    RowBox[{"xIntegral", "[", 
     RowBox[{
      RowBox[{"a", " ", "x"}], ",", 
      RowBox[{"{", 
       RowBox[{"x", ",", "2", ",", "3"}], "}"}]}], "]"}], "]"}], "//", 
   RowBox[{
    RowBox[{"Refine", "[", 
     RowBox[{"#", ",", 
      RowBox[{
       RowBox[{"C", "[", "1", "]"}], "\[Equal]", "0"}]}], "]"}], 
    "&"}]}]}]], "Input",
 CellChangeTimes->{{3.7315100562709703`*^9, 3.731510069613041*^9}, {
  3.73151010704519*^9, 
  3.73151011957889*^9}},ExpressionUUID->"7550822f-3b82-413d-82ab-\
6ad9d7967e15"],

Cell[BoxData[
 TemplateBox[{FractionBox[
    RowBox[{"a", " ", 
      RowBox[{"Log", "[", "z", "]"}]}], "z"],"z",SuperscriptBox[
   "\[ExponentialE]", "2"],SuperscriptBox["\[ExponentialE]", "3"]},
  "InactiveIntegrate",
  DisplayFunction->(RowBox[{
     SubsuperscriptBox[
      StyleBox["\[Integral]", "Inactive"], #3, #4], 
     RowBox[{#, 
       RowBox[{
         StyleBox["\[DifferentialD]", "Inactive"], #2}]}]}]& ),
  InterpretationFunction->(RowBox[{
     RowBox[{"Inactive", "[", "Integrate", "]"}], "[", 
     RowBox[{#, ",", 
       RowBox[{"{", 
         RowBox[{#2, ",", #3, ",", #4}], "}"}]}], "]"}]& )]], "Output",
 CellChangeTimes->{3.731510070543242*^9, 
  3.731510120746566*^9},ExpressionUUID->"174e5f48-75a8-4008-894d-\
016262ea54aa"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"tuIntegralSwitchVar", "[", 
    RowBox[{"y", "\[Rule]", 
     RowBox[{
      SubscriptBox["x", "+"], 
      RowBox[{"fn", "[", "x", "]"}]}]}], "]"}], "[", 
   RowBox[{"xIntegral", "[", 
    RowBox[{
     RowBox[{"a", " ", "x", " ", 
      SubscriptBox["x", "w"]}], ",", 
     RowBox[{"{", 
      RowBox[{"x", ",", "A", ",", "B"}], "}"}]}], "]"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.7315101450142717`*^9, 3.731510162172122*^9}, {
  3.731510260994897*^9, 
  3.7315102921818666`*^9}},ExpressionUUID->"9b6ad065-2952-475e-80ae-\
47e71498c094"],

Cell[BoxData[
 TemplateBox[{FractionBox[
    RowBox[{"a", " ", 
      SubscriptBox["x", "w"], " ", 
      RowBox[{
        TagBox[
         SuperscriptBox["fn", 
          RowBox[{"(", 
            RowBox[{"-", "1"}], ")"}]], {InverseFunction, 1, 1}, Editable -> 
         False], "[", 
        FractionBox["y", 
         SubscriptBox["x", "+"]], "]"}]}], 
    RowBox[{
      SubscriptBox["x", "+"], " ", 
      RowBox[{
        SuperscriptBox["fn", "\[Prime]", MultilineFunction -> None], "[", 
        RowBox[{
          TagBox[
           SuperscriptBox["fn", 
            RowBox[{"(", 
              RowBox[{"-", "1"}], ")"}]], {InverseFunction, 1, 1}, Editable -> 
           False], "[", 
          FractionBox["y", 
           SubscriptBox["x", "+"]], "]"}], "]"}]}]],"y",RowBox[{
     SubscriptBox["x", "+"], " ", 
     RowBox[{
       RowBox[{"InverseFunction", "[", 
         RowBox[{
           TagBox[
            SuperscriptBox["fn", 
             RowBox[{"(", 
               RowBox[{"-", "1"}], ")"}]], {InverseFunction, 1, 1}, Editable -> 
            False], ",", "1", ",", "1"}], "]"}], "[", "A", "]"}]}],RowBox[{
     SubscriptBox["x", "+"], " ", 
     RowBox[{
       RowBox[{"InverseFunction", "[", 
         RowBox[{
           TagBox[
            SuperscriptBox["fn", 
             RowBox[{"(", 
               RowBox[{"-", "1"}], ")"}]], {InverseFunction, 1, 1}, Editable -> 
            False], ",", "1", ",", "1"}], "]"}], "[", "B", "]"}]}]},
  "InactiveIntegrate",
  DisplayFunction->(RowBox[{
     SubsuperscriptBox[
      StyleBox["\[Integral]", "Inactive"], #3, #4], 
     RowBox[{#, 
       RowBox[{
         StyleBox["\[DifferentialD]", "Inactive"], #2}]}]}]& ),
  InterpretationFunction->(RowBox[{
     RowBox[{"Inactive", "[", "Integrate", "]"}], "[", 
     RowBox[{#, ",", 
       RowBox[{"{", 
         RowBox[{#2, ",", #3, ",", #4}], "}"}]}], "]"}]& )]], "Output",
 CellChangeTimes->{
  3.731510163408914*^9, {3.731510263863079*^9, 
   3.7315102936154613`*^9}},ExpressionUUID->"8d11d047-7896-4849-8ab0-\
fa6ed60f96f1"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"xtuIntegralSwitchVar", "[", 
   RowBox[{
    SuperscriptBox["x", "-"], "\[Rule]", 
    RowBox[{
     SuperscriptBox["\[Tau]", "2"], "/", 
     SuperscriptBox["x", "+"]}]}], "]"}], "[", 
  RowBox[{"$0", "[", 
   RowBox[{"[", "2", "]"}], "]"}], "]"}]], "Input",
 CellChangeTimes->{{3.731510347396577*^9, 
  3.731510507391892*^9}},ExpressionUUID->"b9f874e4-289a-40c7-958c-\
ee8835d70e72"],

Cell[CellGroupData[{

Cell[BoxData["ReplaceRepeated"], "Input",
 CellChangeTimes->{{3.731589067153152*^9, 3.731589067275258*^9}, {
  3.731593308430155*^9, 
  3.7315933211325293`*^9}},ExpressionUUID->"5fbdccf0-d0f1-4b56-99c2-\
9541f08a2b0a"],

Cell[BoxData["\[DoubleStruckD]"], "Output",
 CellChangeTimes->{
  3.7315890679919662`*^9},ExpressionUUID->"12974971-11a8-4e21-b96b-\
7a4716772c6f"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{"Clear", "[", "tuIntegralGather", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"tuIntegralGather", "::", "usage"}], "=", 
   "\"\<tuIntegralGather[EXP_] gathers expressions with xIntegral[] under the \
integral if possible. Applies tuIntegralGatherR repeatedly with tuRepeat[] \
since ReplaceRepeated[tuIntegralGatherR] does not seem to work in some cases. \
*1Apr2018*\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"tuIntegralGather", ":=", 
  RowBox[{"tuRepeat", "[", 
   RowBox[{"{", "tuIntegralGatherR", "}"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"tuIntegralGatherR", ":=", 
   RowBox[{"{", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"Conjugate", "[", 
       RowBox[{"xIntegral", "[", 
        RowBox[{"a_", ",", "b_"}], "]"}], "]"}], "\[Rule]", 
      RowBox[{"xIntegral", "[", 
       RowBox[{
        RowBox[{"Conjugate", "[", "a", "]"}], ",", "b"}], "]"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"ConjugateTranspose", "[", 
       RowBox[{"xIntegral", "[", 
        RowBox[{"a_", ",", "b_"}], "]"}], "]"}], "\[Rule]", 
      RowBox[{"xIntegral", "[", 
       RowBox[{
        RowBox[{"ConjugateTranspose", "[", "a", "]"}], ",", "b"}], "]"}]}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"xIntegral", "[", 
       RowBox[{"a_", ",", "b_"}], "]"}], "\[RuleDelayed]", 
      RowBox[{
       RowBox[{"a", " ", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"b", "[", 
           RowBox[{"[", "3", "]"}], "]"}], "-", 
          RowBox[{"b", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], ")"}]}], "/;", 
       RowBox[{
        RowBox[{"NumericQ", "[", "a", "]"}], "&&", 
        RowBox[{
         RowBox[{"Head", "[", "b", "]"}], "===", "List"}], "&&", 
        RowBox[{
         RowBox[{"Length", "[", "b", "]"}], "===", "3"}]}]}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"xIntegral", "[", 
       RowBox[{"a_", ",", "b__"}], "]"}], "\[RuleDelayed]", 
      RowBox[{"xIntegral", "[", 
       RowBox[{"a", ",", 
        RowBox[{"Apply", "[", 
         RowBox[{"Sequence", ",", 
          RowBox[{"Sort", "[", 
           RowBox[{"{", "b", "}"}], "]"}]}], "]"}]}], "]"}]}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{"dd", ":", "productOps"}], ")"}], "[", 
       RowBox[{"a___", ",", 
        RowBox[{"xIntegral", "[", 
         RowBox[{"ia_", ",", "ib_"}], "]"}], ",", "b___"}], "]"}], ":>", 
      RowBox[{"xIntegral", "[", 
       RowBox[{
        RowBox[{"dd", "[", 
         RowBox[{"a", ",", " ", "ia", ",", " ", "b"}], "]"}], ",", "ib"}], 
       "]"}]}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{"dd", ":", "productOps"}], ")"}], "[", 
       RowBox[{
        RowBox[{"xIntegral", "[", 
         RowBox[{"a_", ",", "d_"}], "]"}], " ", ",", " ", 
        RowBox[{"xIntegral", "[", 
         RowBox[{"b_", ",", "c_"}], "]"}]}], " ", "]"}], ":>", 
      RowBox[{"xIntegral", "[", 
       RowBox[{
        RowBox[{"dd", "[", 
         RowBox[{"a", ",", "  ", "b"}], "]"}], ",", "d", ",", "c"}], "]"}]}], 
     ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"xIntegral", "[", 
        RowBox[{"b_", ",", "a__"}], "]"}], "+", 
       RowBox[{"xIntegral", "[", 
        RowBox[{"c_", ",", "a__"}], "]"}]}], "->", 
      RowBox[{"xIntegral", "[", 
       RowBox[{
        RowBox[{"c", "+", "b"}], ",", "a"}], "]"}]}], ",", 
     RowBox[{"(*", 
      RowBox[{"??", 
       RowBox[{"Why", " ", "needed", " ", "if", " ", "next"}]}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{
        SuperscriptBox[
         RowBox[{"(", 
          RowBox[{"c1_:", "1"}], ")"}], 
         RowBox[{"n1_:", "1"}]], " ", 
        RowBox[{"xIntegral", "[", 
         RowBox[{"b_", ",", "a__"}], "]"}]}], "+", 
       RowBox[{
        SuperscriptBox[
         RowBox[{"(", 
          RowBox[{"c2_:", "1"}], ")"}], 
         RowBox[{"n2_:", "1"}]], " ", 
        RowBox[{"xIntegral", "[", 
         RowBox[{"c_", ",", "a__"}], "]"}]}]}], ":>", 
      RowBox[{"xIntegral", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"c2", 
          SuperscriptBox[" ", "n2"], "c"}], "+", 
         RowBox[{
          SuperscriptBox["c1", "n1"], " ", "b"}]}], ",", "a"}], "]"}]}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"xIntegral", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"d_:", "1"}], ")"}], "  ", 
         RowBox[{"xIntegral", "[", 
          RowBox[{"b_", ",", "c_"}], "]"}]}], ",", "a_"}], "  ", "]"}], ":>", 
      
      RowBox[{"xIntegral", "[", 
       RowBox[{
        RowBox[{"d", " ", "b"}], ",", " ", "c", " ", ",", "a"}], "]"}]}]}], 
    "\[IndentingNewLine]", "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"EG", "\[IndentingNewLine]", 
        RowBox[{"xIntegral", "[", 
         RowBox[{"3", ",", "x", ",", 
          RowBox[{"{", 
           RowBox[{"w", ",", "a", ",", "b"}], "}"}], ",", "y"}], "]"}]}], "//", 
       RowBox[{"tuIntegralGather", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"xIntegral", "[", 
          RowBox[{"a", ",", "b"}], "]"}], " ", "\[CenterDot]", 
         RowBox[{"(", 
          RowBox[{"A1", " ", 
           RowBox[{"xIntegral", "[", 
            RowBox[{"a1", ",", "b1"}], "]"}]}], ")"}]}]}]}], "//", 
      RowBox[{"tuIntegralGather", "\[IndentingNewLine]", 
       RowBox[{"xIntegral", "[", 
        RowBox[{
         RowBox[{"aa", " ", "\[CenterDot]", " ", 
          RowBox[{"xIntegral", "[", 
           RowBox[{
            RowBox[{"a1", " ", "a2"}], ",", "b"}], "]"}], "\[CenterDot]", " ",
           "bb"}], ",", "b1"}], "]"}]}]}], "//", 
     RowBox[{
      RowBox[{"tuIntegralGather", "\[IndentingNewLine]", "BB", " ", 
       RowBox[{"xIntegral", "[", 
        RowBox[{"aa", ",", "b"}], "]"}]}], "-", 
      RowBox[{"AA", " ", 
       RowBox[{"xIntegral", "[", 
        RowBox[{"a1", ",", "b"}], "]"}]}]}]}], "//", "tuIntegralGather"}], 
   "*)"}]}]}], "Input",
 CellChangeTimes->CompressedData["
1:eJwd0G1IU3EUBvBRkWA4VGrMsjbpVlIxo1xsQc7yQ2BiK69rUYyRCxotbnPp
JKXIrRllLyjZahCUw42ppeaqtRfJC6KVI+xlQt3VZDmWlJYSJiXt+X84/HgO
Bw7n5B1nDp1YwuPxClIFZaPhF8zo1J4c1RwL70euHDiT8ktCehj6mHQdDAxQ
J2GaMmmETpe6FlaY4/VQniFogKEs7hL8kJ0gqqume+E9vf8pdPjPjcDcx6fD
cG6qfQza+M4IVMlbOch2PopC3VH9N1jXaV8k8zspgTGlbBmzBlZ5Dfmwx/dW
ApcuGBSwudxGjL4X74OSv1QpbG/JoeEP+69K2LA9UwfjcdkpuNlfwkC31lUH
6fQaCyzebbkJZ5a770KlWtEBdb8LPDCmsRCf84cfwk21MwFIVdgGYZrBQVw4
Zn1F9p/dMA6LxAIOssZhIq1kY3DoT9YEvBge/wofHJxMQvve9T9hzWQTvzpl
W3/PKmhbyQghZX8igt+vRfLgddG2jfDy7GI+tGYmtsLGOzukUOINykn/iKkI
Ft66UAKzhbP74bP5bhq+1G5RQY9VrYEGLmiCcc5pJvnT2vNQEPrYCHOn569C
TWW4BfZlsK0wdnu1AzpKFR3QEnV54JjxXRdUBUe85K5ivQ+W/9OG4Jv6skFI
f5YOQfeKG6+haVfbBGwWx4ll/YEkyd3rhCb8eSAqgtXmpkL4H2azqKE=
  
  "],ExpressionUUID->"7e72c229-3d31-4d95-8300-ce03984c94a1"],

Cell[BoxData[
 TemplateBox[{"3","x","y","w","a","b"},
  "InactiveIntegrate",
  DisplayFunction->(RowBox[{
     StyleBox["\[Integral]", "Inactive"], 
     RowBox[{
       StyleBox["\[Integral]", "Inactive"], 
       RowBox[{
         SubsuperscriptBox[
          StyleBox["\[Integral]", "Inactive"], #5, #6], 
         RowBox[{#, 
           RowBox[{
             StyleBox["\[DifferentialD]", "Inactive"], #4}], 
           RowBox[{
             StyleBox["\[DifferentialD]", "Inactive"], #3}], 
           RowBox[{
             StyleBox["\[DifferentialD]", "Inactive"], #2}]}]}]}]}]& ),
  InterpretationFunction->(RowBox[{
     RowBox[{"Inactive", "[", "Integrate", "]"}], "[", 
     RowBox[{#, ",", #2, ",", #3, ",", 
       RowBox[{"{", 
         RowBox[{#4, ",", #5, ",", #6}], "}"}]}], "]"}]& )]], "Output",
 CellChangeTimes->{
  3.731589978727853*^9, {3.7315900400923643`*^9, 3.731590087831417*^9}, {
   3.731590177252706*^9, 3.731590229065053*^9}, {3.7315903955191*^9, 
   3.731590451052395*^9}, 3.7315904852660503`*^9, {3.731590519209235*^9, 
   3.731590556178567*^9}, 3.731590618487986*^9, 3.731590679814517*^9, {
   3.7315907526280413`*^9, 3.7315908534451017`*^9}, 3.73159089685001*^9, 
   3.73159096433715*^9, 3.731590995428698*^9, {3.7315910844883623`*^9, 
   3.731591101851457*^9}, 3.731591143857486*^9, 3.731591177009533*^9, {
   3.731591247050894*^9, 3.731591285112773*^9}, 3.73159134275143*^9, {
   3.731591474482156*^9, 3.731591496689868*^9}, {3.731591531454673*^9, 
   3.731591594363476*^9}, {3.73159163712223*^9, 3.731591668494596*^9}, 
   3.7315917087765207`*^9, {3.731591739433785*^9, 3.731591776536737*^9}, {
   3.731591847689262*^9, 3.7315918584078283`*^9}, 3.731591941708007*^9, {
   3.7315920307472057`*^9, 3.731592053342289*^9}, 3.731592131238791*^9, {
   3.7315921622656403`*^9, 3.731592177737535*^9}, {3.7315922379254837`*^9, 
   3.731592249123266*^9}, 3.7315922887595367`*^9, {3.73159242793754*^9, 
   3.73159248271266*^9}, 3.731592538090526*^9, {3.7315926267966547`*^9, 
   3.731592652818568*^9}, {3.731592692189931*^9, 3.7315927239162207`*^9}, 
   3.7315927955651817`*^9, 3.731593040598778*^9, 3.731593096864691*^9, 
   3.731593431653064*^9, {3.731593485788353*^9, 
   3.731593602893659*^9}},ExpressionUUID->"cc6dccd0-83bc-4073-a5d6-\
efaae63ef3de"],

Cell[BoxData[
 TemplateBox[{RowBox[{"a", "\[CenterDot]", 
     RowBox[{"(", 
       RowBox[{"a1", " ", "A1"}], ")"}]}],"b","b1"},
  "InactiveIntegrate",
  DisplayFunction->(RowBox[{
     StyleBox["\[Integral]", "Inactive"], 
     RowBox[{
       StyleBox["\[Integral]", "Inactive"], 
       RowBox[{#, 
         RowBox[{
           StyleBox["\[DifferentialD]", "Inactive"], #3}], 
         RowBox[{
           StyleBox["\[DifferentialD]", "Inactive"], #2}]}]}]}]& ),
  InterpretationFunction->(RowBox[{
     RowBox[{"Inactive", "[", "Integrate", "]"}], "[", 
     RowBox[{#, ",", #2, ",", #3}], "]"}]& )]], "Output",
 CellChangeTimes->{
  3.731589978727853*^9, {3.7315900400923643`*^9, 3.731590087831417*^9}, {
   3.731590177252706*^9, 3.731590229065053*^9}, {3.7315903955191*^9, 
   3.731590451052395*^9}, 3.7315904852660503`*^9, {3.731590519209235*^9, 
   3.731590556178567*^9}, 3.731590618487986*^9, 3.731590679814517*^9, {
   3.7315907526280413`*^9, 3.7315908534451017`*^9}, 3.73159089685001*^9, 
   3.73159096433715*^9, 3.731590995428698*^9, {3.7315910844883623`*^9, 
   3.731591101851457*^9}, 3.731591143857486*^9, 3.731591177009533*^9, {
   3.731591247050894*^9, 3.731591285112773*^9}, 3.73159134275143*^9, {
   3.731591474482156*^9, 3.731591496689868*^9}, {3.731591531454673*^9, 
   3.731591594363476*^9}, {3.73159163712223*^9, 3.731591668494596*^9}, 
   3.7315917087765207`*^9, {3.731591739433785*^9, 3.731591776536737*^9}, {
   3.731591847689262*^9, 3.7315918584078283`*^9}, 3.731591941708007*^9, {
   3.7315920307472057`*^9, 3.731592053342289*^9}, 3.731592131238791*^9, {
   3.7315921622656403`*^9, 3.731592177737535*^9}, {3.7315922379254837`*^9, 
   3.731592249123266*^9}, 3.7315922887595367`*^9, {3.73159242793754*^9, 
   3.73159248271266*^9}, 3.731592538090526*^9, {3.7315926267966547`*^9, 
   3.731592652818568*^9}, {3.731592692189931*^9, 3.7315927239162207`*^9}, 
   3.7315927955651817`*^9, 3.731593040598778*^9, 3.731593096864691*^9, 
   3.731593431653064*^9, {3.731593485788353*^9, 
   3.731593602909396*^9}},ExpressionUUID->"156fea03-64e6-4684-a5de-\
435e92c2fd07"],

Cell[BoxData[
 TemplateBox[{RowBox[{"aa", "\[CenterDot]", 
     RowBox[{"(", 
       RowBox[{"a1", " ", "a2"}], ")"}], "\[CenterDot]", "bb"}],"b","b1"},
  "InactiveIntegrate",
  DisplayFunction->(RowBox[{
     StyleBox["\[Integral]", "Inactive"], 
     RowBox[{
       StyleBox["\[Integral]", "Inactive"], 
       RowBox[{#, 
         RowBox[{
           StyleBox["\[DifferentialD]", "Inactive"], #3}], 
         RowBox[{
           StyleBox["\[DifferentialD]", "Inactive"], #2}]}]}]}]& ),
  InterpretationFunction->(RowBox[{
     RowBox[{"Inactive", "[", "Integrate", "]"}], "[", 
     RowBox[{#, ",", #2, ",", #3}], "]"}]& )]], "Output",
 CellChangeTimes->{
  3.731589978727853*^9, {3.7315900400923643`*^9, 3.731590087831417*^9}, {
   3.731590177252706*^9, 3.731590229065053*^9}, {3.7315903955191*^9, 
   3.731590451052395*^9}, 3.7315904852660503`*^9, {3.731590519209235*^9, 
   3.731590556178567*^9}, 3.731590618487986*^9, 3.731590679814517*^9, {
   3.7315907526280413`*^9, 3.7315908534451017`*^9}, 3.73159089685001*^9, 
   3.73159096433715*^9, 3.731590995428698*^9, {3.7315910844883623`*^9, 
   3.731591101851457*^9}, 3.731591143857486*^9, 3.731591177009533*^9, {
   3.731591247050894*^9, 3.731591285112773*^9}, 3.73159134275143*^9, {
   3.731591474482156*^9, 3.731591496689868*^9}, {3.731591531454673*^9, 
   3.731591594363476*^9}, {3.73159163712223*^9, 3.731591668494596*^9}, 
   3.7315917087765207`*^9, {3.731591739433785*^9, 3.731591776536737*^9}, {
   3.731591847689262*^9, 3.7315918584078283`*^9}, 3.731591941708007*^9, {
   3.7315920307472057`*^9, 3.731592053342289*^9}, 3.731592131238791*^9, {
   3.7315921622656403`*^9, 3.731592177737535*^9}, {3.7315922379254837`*^9, 
   3.731592249123266*^9}, 3.7315922887595367`*^9, {3.73159242793754*^9, 
   3.73159248271266*^9}, 3.731592538090526*^9, {3.7315926267966547`*^9, 
   3.731592652818568*^9}, {3.731592692189931*^9, 3.7315927239162207`*^9}, 
   3.7315927955651817`*^9, 3.731593040598778*^9, 3.731593096864691*^9, 
   3.731593431653064*^9, {3.731593485788353*^9, 
   3.731593602920766*^9}},ExpressionUUID->"8dd25a13-9037-41b6-9631-\
d76c5f72f1af"],

Cell[BoxData[
 TemplateBox[{RowBox[{"(", 
     RowBox[{
       RowBox[{
         RowBox[{"-", "a1"}], " ", "AA"}], "+", 
       RowBox[{"aa", " ", "BB"}]}], ")"}],"b"},
  "InactiveIntegrate",
  DisplayFunction->(RowBox[{
     StyleBox["\[Integral]", "Inactive"], 
     RowBox[{#, 
       RowBox[{
         StyleBox["\[DifferentialD]", "Inactive"], #2}]}]}]& ),
  InterpretationFunction->(RowBox[{
     RowBox[{"Inactive", "[", "Integrate", "]"}], "[", 
     RowBox[{#, ",", #2}], "]"}]& )]], "Output",
 CellChangeTimes->{
  3.731589978727853*^9, {3.7315900400923643`*^9, 3.731590087831417*^9}, {
   3.731590177252706*^9, 3.731590229065053*^9}, {3.7315903955191*^9, 
   3.731590451052395*^9}, 3.7315904852660503`*^9, {3.731590519209235*^9, 
   3.731590556178567*^9}, 3.731590618487986*^9, 3.731590679814517*^9, {
   3.7315907526280413`*^9, 3.7315908534451017`*^9}, 3.73159089685001*^9, 
   3.73159096433715*^9, 3.731590995428698*^9, {3.7315910844883623`*^9, 
   3.731591101851457*^9}, 3.731591143857486*^9, 3.731591177009533*^9, {
   3.731591247050894*^9, 3.731591285112773*^9}, 3.73159134275143*^9, {
   3.731591474482156*^9, 3.731591496689868*^9}, {3.731591531454673*^9, 
   3.731591594363476*^9}, {3.73159163712223*^9, 3.731591668494596*^9}, 
   3.7315917087765207`*^9, {3.731591739433785*^9, 3.731591776536737*^9}, {
   3.731591847689262*^9, 3.7315918584078283`*^9}, 3.731591941708007*^9, {
   3.7315920307472057`*^9, 3.731592053342289*^9}, 3.731592131238791*^9, {
   3.7315921622656403`*^9, 3.731592177737535*^9}, {3.7315922379254837`*^9, 
   3.731592249123266*^9}, 3.7315922887595367`*^9, {3.73159242793754*^9, 
   3.73159248271266*^9}, 3.731592538090526*^9, {3.7315926267966547`*^9, 
   3.731592652818568*^9}, {3.731592692189931*^9, 3.7315927239162207`*^9}, 
   3.7315927955651817`*^9, 3.731593040598778*^9, 3.731593096864691*^9, 
   3.731593431653064*^9, {3.731593485788353*^9, 
   3.731593602932405*^9}},ExpressionUUID->"1ce7aa51-5106-4c2d-9f89-\
f86023bc37ab"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{"$", "=", 
  RowBox[{
   RowBox[{
    RowBox[{"tuRuleSelect", "[", 
     RowBox[{
      SubscriptBox["P", "_"], ",", 
      RowBox[{"{", "}"}]}], "]"}], "[", 
    RowBox[{"e", "[", "8.86", "]"}], "]"}], "//", 
   "First"}]}], "\[IndentingNewLine]", 
 RowBox[{"$", "=", 
  RowBox[{"$", "/.", 
   RowBox[{
    RowBox[{"xSum", "[", " ", 
     RowBox[{
      RowBox[{"a__", "\[CenterDot]", 
       RowBox[{"(", 
        RowBox[{"kk", ":", 
         RowBox[{
          RowBox[{"Ket", "[", "\[Alpha]", "]"}], "\[CenterDot]", 
          RowBox[{"Bra", "[", "\[Alpha]", "]"}]}]}], ")"}], "\[CenterDot]", 
       "d__"}], ",", "\[Alpha]"}], "]"}], "\[Rule]", 
    RowBox[{"a", "\[CenterDot]", 
     RowBox[{"xSum", "[", " ", 
      RowBox[{
       RowBox[{"CenterDot", "[", "kk", "]"}], " ", ",", "\[Alpha]"}], "]"}], 
     "\[CenterDot]", "d"}]}]}]}], "\[IndentingNewLine]", 
 RowBox[{"$", "=", 
  RowBox[{
   RowBox[{"$", "/.", 
    RowBox[{
     RowBox[{"xSum", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Ket", "[", "\[Alpha]", "]"}], "\[CenterDot]", 
        RowBox[{"Bra", "[", "\[Alpha]", "]"}]}], ",", "\[Alpha]"}], "]"}], 
     "\[Rule]", "1"}]}], "//", 
   RowBox[{"expandDC", "[", "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"$", "=", 
   RowBox[{"$", "//", 
    RowBox[{"tuDotTermRight", "[", 
     RowBox[{
      RowBox[{"Bra", "[", 
       SubscriptBox["iE", "f"], "]"}], ",", 
      RowBox[{"{", 
       SubscriptBox["iE", "f"], "}"}]}], "]"}]}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"\[Rho]", "->", 
  RowBox[{"xSum", "[", 
   RowBox[{
    RowBox[{
     SubscriptBox["p", 
      RowBox[{"j", " "}]], 
     RowBox[{
      RowBox[{"Ket", "[", 
       SubscriptBox["iE", "j"], "]"}], "\[CenterDot]", 
      RowBox[{"Bra", "[", 
       SubscriptBox["iE", "j"], "]"}]}]}], ",", "j"}], 
   "]"}]}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.731668317075877*^9, 3.731668333532023*^9}, {
  3.731668373657583*^9, 3.7316683770676003`*^9}, {3.731754652882196*^9, 
  3.731754707485908*^9}, {3.7317547460105352`*^9, 3.731754810689094*^9}, {
  3.731754868287158*^9, 3.731754876285405*^9}, {3.7317549176763077`*^9, 
  3.7317549223085814`*^9}, {3.7317550224461737`*^9, 3.73175507631458*^9}, {
  3.731755150114121*^9, 3.7317551664343452`*^9}, {3.731755215105774*^9, 
  3.731755215910232*^9}, {3.7317552609069967`*^9, 3.731755282291551*^9}, {
  3.731755317712068*^9, 3.7317555937598677`*^9}, {3.731755660628139*^9, 
  3.7317556651302347`*^9}},ExpressionUUID->"14c039e3-96bf-4017-836a-\
63133a8af41d"],

Cell[BoxData[
 RowBox[{
  SubscriptBox["P", 
   RowBox[{
    SubscriptBox[
     StyleBox["\<\"E\"\>",
      StripOnInput->False,
      FontSlant->Italic], "i"], "\[Rule]", 
    SubscriptBox[
     StyleBox["\<\"E\"\>",
      StripOnInput->False,
      FontSlant->Italic], "f"]}]], "\[Rule]", 
  InterpretationBox[
   RowBox[{
    UnderscriptBox[
     UnderscriptBox["\<\"\[Sum]\"\>", "_"], 
     TagBox[GridBox[{
        {"j"}
       },
       DefaultBaseStyle->"Column",
       GridBoxAlignment->{"Columns" -> {{Left}}},
       GridBoxItemSize->{"Columns" -> {{Automatic}}, "Rows" -> {{Automatic}}}],
      "Column"]], "[", 
    InterpretationBox[
     RowBox[{
      UnderscriptBox[
       UnderscriptBox["\<\"\[Sum]\"\>", "_"], 
       TagBox[GridBox[{
          {"\[Alpha]"}
         },
         DefaultBaseStyle->"Column",
         GridBoxAlignment->{"Columns" -> {{Left}}},
         GridBoxItemSize->{
          "Columns" -> {{Automatic}}, "Rows" -> {{Automatic}}}],
        "Column"]], "[", 
      RowBox[{
       InterpretationBox[
        RowBox[{
         StyleBox["\[LeftAngleBracket]",
          FontWeight->Bold], 
         SubscriptBox[
          StyleBox["\<\"E\"\>",
           StripOnInput->False,
           FontSlant->Italic], "f"], 
         StyleBox["\[RightBracketingBar]",
          FontWeight->Bold]}],
        Bra[
         Subscript[
          Style["E", Italic], $CellContext`f]],
        Editable->False,
        SyntaxForm->Automatic], "\[CenterDot]", 
       InterpretationBox[
        RowBox[{
         StyleBox["\[LeftBracketingBar]",
          FontWeight->Bold], 
         SubscriptBox[
          StyleBox["\<\"E\"\>",
           StripOnInput->False,
           FontSlant->Italic], "j"], 
         StyleBox["\[RightAngleBracket]",
          FontWeight->Bold]}],
        Ket[
         Subscript[
          Style["E", Italic], $CellContext`j]],
        Editable->False,
        SyntaxForm->Automatic], "\[CenterDot]", 
       InterpretationBox[
        RowBox[{
         StyleBox["\[LeftAngleBracket]",
          FontWeight->Bold], 
         SubscriptBox[
          StyleBox["\<\"E\"\>",
           StripOnInput->False,
           FontSlant->Italic], "j"], 
         StyleBox["\[RightBracketingBar]",
          FontWeight->Bold]}],
        Bra[
         Subscript[
          Style["E", Italic], $CellContext`j]],
        Editable->False,
        SyntaxForm->Automatic], "\[CenterDot]", 
       InterpretationBox[
        RowBox[{
         StyleBox["\[LeftBracketingBar]",
          FontWeight->Bold], 
         SubscriptBox[
          StyleBox["\<\"E\"\>",
           StripOnInput->False,
           FontSlant->Italic], "f"], 
         StyleBox["\[RightAngleBracket]",
          FontWeight->Bold]}],
        Ket[
         Subscript[
          Style["E", Italic], $CellContext`f]],
        Editable->False,
        SyntaxForm->Automatic], "\[CenterDot]", 
       InterpretationBox[
        RowBox[{
         StyleBox["\[LeftAngleBracket]",
          FontWeight->Bold], 
         SubscriptBox["f", "out"], 
         StyleBox["\[RightBracketingBar]",
          FontWeight->Bold]}],
        Bra[
         Subscript[$CellContext`f, $CellContext`out]],
        Editable->False,
        SyntaxForm->Automatic], "\[CenterDot]", 
       InterpretationBox[
        RowBox[{
         StyleBox["\[LeftBracketingBar]",
          FontWeight->Bold], "\[Alpha]", 
         StyleBox["\[RightAngleBracket]",
          FontWeight->Bold]}],
        Ket[$CellContext`\[Alpha]],
        Editable->False,
        SyntaxForm->Automatic], "\[CenterDot]", 
       InterpretationBox[
        RowBox[{
         StyleBox["\[LeftAngleBracket]",
          FontWeight->Bold], "\[Alpha]", 
         StyleBox["\[RightBracketingBar]",
          FontWeight->Bold]}],
        Bra[$CellContext`\[Alpha]],
        Editable->False,
        SyntaxForm->Automatic], "\[CenterDot]", 
       InterpretationBox[
        RowBox[{
         StyleBox["\[LeftBracketingBar]",
          FontWeight->Bold], 
         SubscriptBox["f", "out"], 
         StyleBox["\[RightAngleBracket]",
          FontWeight->Bold]}],
        Ket[
         Subscript[$CellContext`f, $CellContext`out]],
        Editable->False,
        SyntaxForm->Automatic]}], "]"}],
     $CellContext`xSum[
      CenterDot[
       Bra[
        Subscript[
         Style["E", Italic], $CellContext`f]], 
       Ket[
        Subscript[
         Style["E", Italic], $CellContext`j]], 
       Bra[
        Subscript[
         Style["E", Italic], $CellContext`j]], 
       Ket[
        Subscript[
         Style["E", Italic], $CellContext`f]], 
       Bra[
        Subscript[$CellContext`f, $CellContext`out]], 
       Ket[$CellContext`\[Alpha]], 
       Bra[$CellContext`\[Alpha]], 
       Ket[
        Subscript[$CellContext`f, $CellContext`out]]], $CellContext`\[Alpha]],
     
     Editable->False,
     SyntaxForm->Automatic], "]"}],
   $CellContext`xSum[
    $CellContext`xSum[
     CenterDot[
      Bra[
       Subscript[
        Style["E", Italic], $CellContext`f]], 
      Ket[
       Subscript[
        Style["E", Italic], $CellContext`j]], 
      Bra[
       Subscript[
        Style["E", Italic], $CellContext`j]], 
      Ket[
       Subscript[
        Style["E", Italic], $CellContext`f]], 
      Bra[
       Subscript[$CellContext`f, $CellContext`out]], 
      Ket[$CellContext`\[Alpha]], 
      Bra[$CellContext`\[Alpha]], 
      Ket[
       Subscript[$CellContext`f, $CellContext`out]]], $CellContext`\[Alpha]], \
$CellContext`j],
   Editable->False,
   SyntaxForm->Automatic]}]], "Output",
 CellChangeTimes->{{3.731754699114272*^9, 3.731754709545065*^9}, {
   3.731754751426588*^9, 3.731754811994904*^9}, {3.731754870169944*^9, 
   3.7317548774511127`*^9}, 3.731754923841464*^9, {3.7317550253774157`*^9, 
   3.731755044235395*^9}, 3.73175507726084*^9, 3.7317551701290817`*^9, 
   3.7317552168948507`*^9, 3.7317553308208*^9, {3.731755413081593*^9, 
   3.731755425029501*^9}, 3.731755471442196*^9, {3.731755575905162*^9, 
   3.731755594769445*^9}, 
   3.7317556660944767`*^9},ExpressionUUID->"78dfd38c-3691-44f8-8d56-\
80ceddbf9201"],

Cell[BoxData[
 RowBox[{
  SubscriptBox["P", 
   RowBox[{
    SubscriptBox[
     StyleBox["\<\"E\"\>",
      StripOnInput->False,
      FontSlant->Italic], "i"], "\[Rule]", 
    SubscriptBox[
     StyleBox["\<\"E\"\>",
      StripOnInput->False,
      FontSlant->Italic], "f"]}]], "\[Rule]", 
  InterpretationBox[
   RowBox[{
    UnderscriptBox[
     UnderscriptBox["\<\"\[Sum]\"\>", "_"], 
     TagBox[GridBox[{
        {"j"}
       },
       DefaultBaseStyle->"Column",
       GridBoxAlignment->{"Columns" -> {{Left}}},
       GridBoxItemSize->{"Columns" -> {{Automatic}}, "Rows" -> {{Automatic}}}],
      "Column"]], "[", 
    RowBox[{
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftAngleBracket]",
        FontWeight->Bold], 
       SubscriptBox[
        StyleBox["\<\"E\"\>",
         StripOnInput->False,
         FontSlant->Italic], "f"], 
       StyleBox["\[RightBracketingBar]",
        FontWeight->Bold]}],
      Bra[
       Subscript[
        Style["E", Italic], $CellContext`f]],
      Editable->False,
      SyntaxForm->Automatic], "\[CenterDot]", 
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftBracketingBar]",
        FontWeight->Bold], 
       SubscriptBox[
        StyleBox["\<\"E\"\>",
         StripOnInput->False,
         FontSlant->Italic], "j"], 
       StyleBox["\[RightAngleBracket]",
        FontWeight->Bold]}],
      Ket[
       Subscript[
        Style["E", Italic], $CellContext`j]],
      Editable->False,
      SyntaxForm->Automatic], "\[CenterDot]", 
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftAngleBracket]",
        FontWeight->Bold], 
       SubscriptBox[
        StyleBox["\<\"E\"\>",
         StripOnInput->False,
         FontSlant->Italic], "j"], 
       StyleBox["\[RightBracketingBar]",
        FontWeight->Bold]}],
      Bra[
       Subscript[
        Style["E", Italic], $CellContext`j]],
      Editable->False,
      SyntaxForm->Automatic], "\[CenterDot]", 
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftBracketingBar]",
        FontWeight->Bold], 
       SubscriptBox[
        StyleBox["\<\"E\"\>",
         StripOnInput->False,
         FontSlant->Italic], "f"], 
       StyleBox["\[RightAngleBracket]",
        FontWeight->Bold]}],
      Ket[
       Subscript[
        Style["E", Italic], $CellContext`f]],
      Editable->False,
      SyntaxForm->Automatic], "\[CenterDot]", 
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftAngleBracket]",
        FontWeight->Bold], 
       SubscriptBox["f", "out"], 
       StyleBox["\[RightBracketingBar]",
        FontWeight->Bold]}],
      Bra[
       Subscript[$CellContext`f, $CellContext`out]],
      Editable->False,
      SyntaxForm->Automatic], "\[CenterDot]", 
     InterpretationBox[
      RowBox[{
       UnderscriptBox[
        UnderscriptBox["\<\"\[Sum]\"\>", "_"], 
        TagBox[GridBox[{
           {"\[Alpha]"}
          },
          DefaultBaseStyle->"Column",
          GridBoxAlignment->{"Columns" -> {{Left}}},
          
          GridBoxItemSize->{
           "Columns" -> {{Automatic}}, "Rows" -> {{Automatic}}}],
         "Column"]], "[", 
       RowBox[{
        InterpretationBox[
         RowBox[{
          StyleBox["\[LeftBracketingBar]",
           FontWeight->Bold], "\[Alpha]", 
          StyleBox["\[RightAngleBracket]",
           FontWeight->Bold]}],
         Ket[$CellContext`\[Alpha]],
         Editable->False,
         SyntaxForm->Automatic], "\[CenterDot]", 
        InterpretationBox[
         RowBox[{
          StyleBox["\[LeftAngleBracket]",
           FontWeight->Bold], "\[Alpha]", 
          StyleBox["\[RightBracketingBar]",
           FontWeight->Bold]}],
         Bra[$CellContext`\[Alpha]],
         Editable->False,
         SyntaxForm->Automatic]}], "]"}],
      $CellContext`xSum[
       CenterDot[
        Ket[$CellContext`\[Alpha]], 
        Bra[$CellContext`\[Alpha]]], $CellContext`\[Alpha]],
      Editable->False,
      SyntaxForm->Automatic], "\[CenterDot]", 
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftBracketingBar]",
        FontWeight->Bold], 
       SubscriptBox["f", "out"], 
       StyleBox["\[RightAngleBracket]",
        FontWeight->Bold]}],
      Ket[
       Subscript[$CellContext`f, $CellContext`out]],
      Editable->False,
      SyntaxForm->Automatic]}], "]"}],
   $CellContext`xSum[
    CenterDot[
     Bra[
      Subscript[
       Style["E", Italic], $CellContext`f]], 
     Ket[
      Subscript[
       Style["E", Italic], $CellContext`j]], 
     Bra[
      Subscript[
       Style["E", Italic], $CellContext`j]], 
     Ket[
      Subscript[
       Style["E", Italic], $CellContext`f]], 
     Bra[
      Subscript[$CellContext`f, $CellContext`out]], 
     $CellContext`xSum[
      CenterDot[
       Ket[$CellContext`\[Alpha]], 
       Bra[$CellContext`\[Alpha]]], $CellContext`\[Alpha]], 
     Ket[
      Subscript[$CellContext`f, $CellContext`out]]], $CellContext`j],
   Editable->False,
   SyntaxForm->Automatic]}]], "Output",
 CellChangeTimes->{{3.731754699114272*^9, 3.731754709545065*^9}, {
   3.731754751426588*^9, 3.731754811994904*^9}, {3.731754870169944*^9, 
   3.7317548774511127`*^9}, 3.731754923841464*^9, {3.7317550253774157`*^9, 
   3.731755044235395*^9}, 3.73175507726084*^9, 3.7317551701290817`*^9, 
   3.7317552168948507`*^9, 3.7317553308208*^9, {3.731755413081593*^9, 
   3.731755425029501*^9}, 3.731755471442196*^9, {3.731755575905162*^9, 
   3.731755594769445*^9}, 
   3.731755666122443*^9},ExpressionUUID->"3c281150-8512-4098-8840-\
b831c0927627"],

Cell[BoxData[
 RowBox[{
  SubscriptBox["P", 
   RowBox[{
    SubscriptBox[
     StyleBox["\<\"E\"\>",
      StripOnInput->False,
      FontSlant->Italic], "i"], "\[Rule]", 
    SubscriptBox[
     StyleBox["\<\"E\"\>",
      StripOnInput->False,
      FontSlant->Italic], "f"]}]], "\[Rule]", 
  InterpretationBox[
   RowBox[{
    UnderscriptBox[
     UnderscriptBox["\<\"\[Sum]\"\>", "_"], 
     TagBox[GridBox[{
        {"j"}
       },
       DefaultBaseStyle->"Column",
       GridBoxAlignment->{"Columns" -> {{Left}}},
       GridBoxItemSize->{"Columns" -> {{Automatic}}, "Rows" -> {{Automatic}}}],
      "Column"]], "[", 
    RowBox[{
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftAngleBracket]",
        FontWeight->Bold], 
       SubscriptBox[
        StyleBox["\<\"E\"\>",
         StripOnInput->False,
         FontSlant->Italic], "f"], 
       StyleBox["\[RightBracketingBar]",
        FontWeight->Bold]}],
      Bra[
       Subscript[
        Style["E", Italic], $CellContext`f]],
      Editable->False,
      SyntaxForm->Automatic], "\[CenterDot]", 
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftBracketingBar]",
        FontWeight->Bold], 
       SubscriptBox[
        StyleBox["\<\"E\"\>",
         StripOnInput->False,
         FontSlant->Italic], "j"], 
       StyleBox["\[RightAngleBracket]",
        FontWeight->Bold]}],
      Ket[
       Subscript[
        Style["E", Italic], $CellContext`j]],
      Editable->False,
      SyntaxForm->Automatic], "\[CenterDot]", 
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftAngleBracket]",
        FontWeight->Bold], 
       SubscriptBox[
        StyleBox["\<\"E\"\>",
         StripOnInput->False,
         FontSlant->Italic], "j"], 
       StyleBox["\[RightBracketingBar]",
        FontWeight->Bold]}],
      Bra[
       Subscript[
        Style["E", Italic], $CellContext`j]],
      Editable->False,
      SyntaxForm->Automatic], "\[CenterDot]", 
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftBracketingBar]",
        FontWeight->Bold], 
       SubscriptBox[
        StyleBox["\<\"E\"\>",
         StripOnInput->False,
         FontSlant->Italic], "f"], 
       StyleBox["\[RightAngleBracket]",
        FontWeight->Bold]}],
      Ket[
       Subscript[
        Style["E", Italic], $CellContext`f]],
      Editable->False,
      SyntaxForm->Automatic], "\[CenterDot]", 
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftAngleBracket]",
        FontWeight->Bold], 
       SubscriptBox["f", "out"], 
       StyleBox["\[RightBracketingBar]",
        FontWeight->Bold]}],
      Bra[
       Subscript[$CellContext`f, $CellContext`out]],
      Editable->False,
      SyntaxForm->Automatic], "\[CenterDot]", 
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftBracketingBar]",
        FontWeight->Bold], 
       SubscriptBox["f", "out"], 
       StyleBox["\[RightAngleBracket]",
        FontWeight->Bold]}],
      Ket[
       Subscript[$CellContext`f, $CellContext`out]],
      Editable->False,
      SyntaxForm->Automatic]}], "]"}],
   $CellContext`xSum[
    CenterDot[
     Bra[
      Subscript[
       Style["E", Italic], $CellContext`f]], 
     Ket[
      Subscript[
       Style["E", Italic], $CellContext`j]], 
     Bra[
      Subscript[
       Style["E", Italic], $CellContext`j]], 
     Ket[
      Subscript[
       Style["E", Italic], $CellContext`f]], 
     Bra[
      Subscript[$CellContext`f, $CellContext`out]], 
     Ket[
      Subscript[$CellContext`f, $CellContext`out]]], $CellContext`j],
   Editable->False,
   SyntaxForm->Automatic]}]], "Output",
 CellChangeTimes->{{3.731754699114272*^9, 3.731754709545065*^9}, {
   3.731754751426588*^9, 3.731754811994904*^9}, {3.731754870169944*^9, 
   3.7317548774511127`*^9}, 3.731754923841464*^9, {3.7317550253774157`*^9, 
   3.731755044235395*^9}, 3.73175507726084*^9, 3.7317551701290817`*^9, 
   3.7317552168948507`*^9, 3.7317553308208*^9, {3.731755413081593*^9, 
   3.731755425029501*^9}, 3.731755471442196*^9, {3.731755575905162*^9, 
   3.731755594769445*^9}, 
   3.731755666134314*^9},ExpressionUUID->"8dadad34-c434-4a48-8f07-\
ec8a5bda564a"],

Cell[BoxData[
 RowBox[{
  SubscriptBox["P", 
   RowBox[{
    SubscriptBox[
     StyleBox["\<\"E\"\>",
      StripOnInput->False,
      FontSlant->Italic], "i"], "\[Rule]", 
    SubscriptBox[
     StyleBox["\<\"E\"\>",
      StripOnInput->False,
      FontSlant->Italic], "f"]}]], "\[Rule]", 
  InterpretationBox[
   RowBox[{
    UnderscriptBox[
     UnderscriptBox["\<\"\[Sum]\"\>", "_"], 
     TagBox[GridBox[{
        {"j"}
       },
       DefaultBaseStyle->"Column",
       GridBoxAlignment->{"Columns" -> {{Left}}},
       GridBoxItemSize->{"Columns" -> {{Automatic}}, "Rows" -> {{Automatic}}}],
      "Column"]], "[", 
    RowBox[{
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftBracketingBar]",
        FontWeight->Bold], 
       SubscriptBox[
        StyleBox["\<\"E\"\>",
         StripOnInput->False,
         FontSlant->Italic], "j"], 
       StyleBox["\[RightAngleBracket]",
        FontWeight->Bold]}],
      Ket[
       Subscript[
        Style["E", Italic], $CellContext`j]],
      Editable->False,
      SyntaxForm->Automatic], "\[CenterDot]", 
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftAngleBracket]",
        FontWeight->Bold], 
       SubscriptBox[
        StyleBox["\<\"E\"\>",
         StripOnInput->False,
         FontSlant->Italic], "j"], 
       StyleBox["\[RightBracketingBar]",
        FontWeight->Bold]}],
      Bra[
       Subscript[
        Style["E", Italic], $CellContext`j]],
      Editable->False,
      SyntaxForm->Automatic], "\[CenterDot]", 
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftAngleBracket]",
        FontWeight->Bold], 
       SubscriptBox[
        StyleBox["\<\"E\"\>",
         StripOnInput->False,
         FontSlant->Italic], "f"], 
       StyleBox["\[RightBracketingBar]",
        FontWeight->Bold]}],
      Bra[
       Subscript[
        Style["E", Italic], $CellContext`f]],
      Editable->False,
      SyntaxForm->Automatic], "\[CenterDot]", 
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftBracketingBar]",
        FontWeight->Bold], 
       SubscriptBox[
        StyleBox["\<\"E\"\>",
         StripOnInput->False,
         FontSlant->Italic], "f"], 
       StyleBox["\[RightAngleBracket]",
        FontWeight->Bold]}],
      Ket[
       Subscript[
        Style["E", Italic], $CellContext`f]],
      Editable->False,
      SyntaxForm->Automatic], "\[CenterDot]", 
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftAngleBracket]",
        FontWeight->Bold], 
       SubscriptBox["f", "out"], 
       StyleBox["\[RightBracketingBar]",
        FontWeight->Bold]}],
      Bra[
       Subscript[$CellContext`f, $CellContext`out]],
      Editable->False,
      SyntaxForm->Automatic], "\[CenterDot]", 
     InterpretationBox[
      RowBox[{
       StyleBox["\[LeftBracketingBar]",
        FontWeight->Bold], 
       SubscriptBox["f", "out"], 
       StyleBox["\[RightAngleBracket]",
        FontWeight->Bold]}],
      Ket[
       Subscript[$CellContext`f, $CellContext`out]],
      Editable->False,
      SyntaxForm->Automatic]}], "]"}],
   $CellContext`xSum[
    CenterDot[
     Ket[
      Subscript[
       Style["E", Italic], $CellContext`j]], 
     Bra[
      Subscript[
       Style["E", Italic], $CellContext`j]], 
     Bra[
      Subscript[
       Style["E", Italic], $CellContext`f]], 
     Ket[
      Subscript[
       Style["E", Italic], $CellContext`f]], 
     Bra[
      Subscript[$CellContext`f, $CellContext`out]], 
     Ket[
      Subscript[$CellContext`f, $CellContext`out]]], $CellContext`j],
   Editable->False,
   SyntaxForm->Automatic]}]], "Output",
 CellChangeTimes->{{3.731754699114272*^9, 3.731754709545065*^9}, {
   3.731754751426588*^9, 3.731754811994904*^9}, {3.731754870169944*^9, 
   3.7317548774511127`*^9}, 3.731754923841464*^9, {3.7317550253774157`*^9, 
   3.731755044235395*^9}, 3.73175507726084*^9, 3.7317551701290817`*^9, 
   3.7317552168948507`*^9, 3.7317553308208*^9, {3.731755413081593*^9, 
   3.731755425029501*^9}, 3.731755471442196*^9, {3.731755575905162*^9, 
   3.731755594769445*^9}, 
   3.731755666142332*^9},ExpressionUUID->"434837bd-fc51-4590-8ce4-\
99c379d9f410"],

Cell[BoxData[
 RowBox[{"\[Rho]", "\[Rule]", 
  InterpretationBox[
   RowBox[{
    UnderscriptBox[
     UnderscriptBox["\<\"\[Sum]\"\>", "_"], 
     TagBox[GridBox[{
        {"j"}
       },
       DefaultBaseStyle->"Column",
       GridBoxAlignment->{"Columns" -> {{Left}}},
       GridBoxItemSize->{"Columns" -> {{Automatic}}, "Rows" -> {{Automatic}}}],
      "Column"]], "[", 
    RowBox[{
     RowBox[{
      InterpretationBox[
       RowBox[{
        StyleBox["\[LeftBracketingBar]",
         FontWeight->Bold], 
        SubscriptBox[
         StyleBox["\<\"E\"\>",
          StripOnInput->False,
          FontSlant->Italic], "j"], 
        StyleBox["\[RightAngleBracket]",
         FontWeight->Bold]}],
       Ket[
        Subscript[
         Style["E", Italic], $CellContext`j]],
       Editable->False,
       SyntaxForm->Automatic], "\[CenterDot]", 
      InterpretationBox[
       RowBox[{
        StyleBox["\[LeftAngleBracket]",
         FontWeight->Bold], 
        SubscriptBox[
         StyleBox["\<\"E\"\>",
          StripOnInput->False,
          FontSlant->Italic], "j"], 
        StyleBox["\[RightBracketingBar]",
         FontWeight->Bold]}],
       Bra[
        Subscript[
         Style["E", Italic], $CellContext`j]],
       Editable->False,
       SyntaxForm->Automatic]}], " ", 
     SubscriptBox["p", "j"]}], "]"}],
   $CellContext`xSum[CenterDot[
      Ket[
       Subscript[
        Style["E", Italic], $CellContext`j]], 
      Bra[
       Subscript[
        Style["E", Italic], $CellContext`j]]] 
    Subscript[$CellContext`p, $CellContext`j], $CellContext`j],
   Editable->False,
   SyntaxForm->Automatic]}]], "Output",
 CellChangeTimes->{{3.731754699114272*^9, 3.731754709545065*^9}, {
   3.731754751426588*^9, 3.731754811994904*^9}, {3.731754870169944*^9, 
   3.7317548774511127`*^9}, 3.731754923841464*^9, {3.7317550253774157`*^9, 
   3.731755044235395*^9}, 3.73175507726084*^9, 3.7317551701290817`*^9, 
   3.7317552168948507`*^9, 3.7317553308208*^9, {3.731755413081593*^9, 
   3.731755425029501*^9}, 3.731755471442196*^9, {3.731755575905162*^9, 
   3.731755594769445*^9}, 
   3.7317556661504107`*^9},ExpressionUUID->"7afedfd2-fdc0-4216-bec8-\
ab52eb4241da"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"$", "=", 
    RowBox[{"g", "\[Rule]", 
     RowBox[{"f", "-", 
      RowBox[{"p", " ", "x"}]}]}]}], "\[IndentingNewLine]", 
   RowBox[{"$", "=", 
    RowBox[{
     RowBox[{
      RowBox[{"d", "[", "#", "]"}], "&"}], "/@", "$"}]}], 
   "\[IndentingNewLine]", 
   RowBox[{"$", "=", 
    RowBox[{"$", "//", 
     RowBox[{"tudExpand", "[", "d", "]"}]}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"//", 
       RowBox[{"tuDExpandF", "[", "d", "]"}]}], "//", 
      RowBox[{"tuD2tuDOp", "[", 
       RowBox[{"tuDDown", "[", "d", "]"}], "]"}]}], "//", 
     RowBox[{"tuArgRemove", "[", 
      RowBox[{"f", "|", "g"}], "]"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"$s", "=", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"tuDDown", "[", "d", "]"}], "[", 
         RowBox[{"g", ",", "p"}], "]"}], "\[Rule]", 
        RowBox[{"-", "x"}]}], ",", 
       RowBox[{
        RowBox[{
         RowBox[{"tuDDown", "[", "d", "]"}], "[", 
         RowBox[{"g", ",", "y"}], "]"}], "\[Rule]", "v"}]}], "}"}]}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"$", "=", 
     RowBox[{"$", "/.", "$s"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"$", "//", "tuRuleSimplify"}], "}"}], "[", 
     RowBox[{"CG", "[", "\"\<derivatives equal\>\"", "]"}], 
     "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.731767182857635*^9, 3.7317672647949343`*^9}},
 EmphasizeSyntaxErrors->
  True,ExpressionUUID->"48be67a9-4f1b-488a-bd4d-9111b25a8f6c"],

Cell[BoxData[
 RowBox[{"g", "\[Rule]", 
  RowBox[{"f", "-", 
   RowBox[{"p", " ", "x"}]}]}]], "Output",
 CellChangeTimes->{{3.731767214838235*^9, 
  3.7317672665419273`*^9}},ExpressionUUID->"7dfa8b3a-33a5-4081-8c86-\
52d89fc83a38"],

Cell[BoxData[
 RowBox[{
  RowBox[{"d", "[", "g", "]"}], "\[Rule]", 
  RowBox[{"d", "[", 
   RowBox[{"f", "-", 
    RowBox[{"p", " ", "x"}]}], "]"}]}]], "Output",
 CellChangeTimes->{{3.731767214838235*^9, 
  3.731767266554811*^9}},ExpressionUUID->"3ad3fca0-12e6-4e57-9222-\
6f0f9cd71890"],

Cell[BoxData[
 RowBox[{
  RowBox[{"d", "[", "g", "]"}], "\[Rule]", 
  RowBox[{
   RowBox[{"d", "[", "f", "]"}], "-", 
   RowBox[{"x", " ", 
    RowBox[{"d", "[", "p", "]"}]}], "-", 
   RowBox[{"p", " ", 
    RowBox[{"d", "[", "x", "]"}]}]}]}]], "Output",
 CellChangeTimes->{{3.731767214838235*^9, 
  3.731767266564178*^9}},ExpressionUUID->"ae6726b3-3bec-4c75-8b62-\
777ab807dfdc"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"tudExpand", "[", 
      RowBox[{"\[Delta]1_", ",", 
       RowBox[{"constants_List:", 
        RowBox[{"{", "}"}]}]}], "]"}], "[", "exp_", "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"tmp", "=", "exp"}], ",", "sub", ",", "name", ",", "tmp0", 
        ",", "xtmp", ",", "$dum", ",", 
        RowBox[{"ProductOp", "=", 
         RowBox[{"Flatten", "[", 
          RowBox[{
          "BraKet", "|", "Times", "|", "dotOps", "|", "Wedge", "|", 
           "CircleTimes"}], "]"}]}]}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"sub", "=", 
        RowBox[{
         RowBox[{"{", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", "a_", "]"}], ":>", 
            RowBox[{"0", "/;", 
             RowBox[{"NumericQ", "[", "a", "]"}]}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", "a_", "]"}], ":>", 
            RowBox[{"0", "/;", 
             RowBox[{"ListMemberQ", "[", 
              RowBox[{"a", ",", "constants"}], "]"}]}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", 
             RowBox[{"a_", "^", "n_"}], "]"}], ":>", 
            RowBox[{"0", "/;", 
             RowBox[{
              RowBox[{"ListMemberQ", "[", 
               RowBox[{"a", ",", "constants"}], "]"}], "&&", 
              RowBox[{"NumericQ", "[", "n", "]"}]}]}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", 
             RowBox[{"1", "/", "a_"}], "]"}], ":>", 
            RowBox[{"0", "/;", 
             RowBox[{"ListMemberQ", "[", 
              RowBox[{"a", ",", "constants"}], "]"}]}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", 
             RowBox[{"1", "/", 
              RowBox[{"a_", "^", "n_"}]}], "]"}], ":>", 
            RowBox[{"0", "/;", 
             RowBox[{
              RowBox[{"ListMemberQ", "[", 
               RowBox[{"a", ",", "constants"}], "]"}], "&&", 
              RowBox[{"NumericQ", "[", "n", "]"}]}]}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", 
             RowBox[{"Conjugate", "[", "a_", "]"}], "]"}], ":>", 
            RowBox[{"Conjugate", "[", 
             RowBox[{"name", "[", "a", "]"}], "]"}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", 
             RowBox[{"ConjugateTranspose", "[", "a_", "]"}], "]"}], ":>", 
            RowBox[{"ConjugateTranspose", "[", 
             RowBox[{"name", "[", "a", "]"}], "]"}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", 
             RowBox[{"Transpose", "[", "a_", "]"}], "]"}], ":>", 
            RowBox[{"Transpose", "[", 
             RowBox[{"name", "[", "a", "]"}], "]"}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", 
             RowBox[{"Tr", "[", "a_", "]"}], "]"}], "\[RuleDelayed]", 
            RowBox[{"Tr", "[", 
             RowBox[{"name", "[", "a", "]"}], "]"}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", "a__", "]"}], ":>", 
            RowBox[{
             RowBox[{"Thread", "[", 
              RowBox[{"name", "[", "a", "]"}], "]"}], "/;", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"Head", "[", "a", "]"}], "==", "List"}], ")"}]}]}], 
           ",", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"OP", ":", "DerivOps"}], ")"}], "[", 
              RowBox[{"T_", ",", "i___"}], "]"}], "]"}], "\[Rule]", 
            RowBox[{"OP", "[", 
             RowBox[{
              RowBox[{"name", "[", "T", "]"}], ",", "i"}], "]"}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", 
             RowBox[{"Exp", "[", "a_", "]"}], "]"}], "->", 
            RowBox[{
             RowBox[{"Exp", "[", "a", "]"}], " ", 
             RowBox[{"name", "[", "a", "]"}]}]}], ",", "\[IndentingNewLine]", 
           
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", 
             RowBox[{"Log", "[", "a_", "]"}], "]"}], "->", " ", 
            RowBox[{
             RowBox[{"name", "[", "a", "]"}], "/", "a"}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", 
             RowBox[{"a_", "^", "n_"}], "]"}], "\[RuleDelayed]", 
            RowBox[{"n", " ", 
             RowBox[{"name", "[", "a", "]"}], 
             RowBox[{"a", "^", 
              RowBox[{"(", 
               RowBox[{"n", "-", "1"}], ")"}]}]}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"tt", ":", 
                RowBox[{"Apply", "[", 
                 RowBox[{"Alternatives", ",", "tuTrigFunc"}], "]"}]}], ")"}], 
              "[", "t_", "]"}], "]"}], "\[RuleDelayed]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"D", "[", 
                RowBox[{
                 RowBox[{"tt", "[", "$dum", "]"}], ",", "$dum"}], "]"}], 
               RowBox[{"name", "[", "t", "]"}]}], "/.", 
              RowBox[{"$dum", "\[Rule]", "t"}]}], ")"}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"0", "&"}], "->", "0"}], ")"}]}], " ", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{
             RowBox[{"in", " ", "case", " ", "\[Delta]1", " ", "is", " ", 
              RowBox[{"Derivative", "[", "1", "]"}], " ", "which", " ", 
              "produces", " ", "0"}], "&"}], " ", "for", " ", 
            RowBox[{"NumberQ", "."}]}], " ", "*)"}], "\[IndentingNewLine]", 
          "}"}], "//", "Flatten"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"tmp", "=!=", "tmp0"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"tmp0", "=", "tmp"}], ";", "\[IndentingNewLine]", 
          RowBox[{"tmp", "=", 
           RowBox[{"tmp", "//", "ExpandAll"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"tmp", "=", 
           RowBox[{"tmp", "//.", 
            RowBox[{
             RowBox[{
              RowBox[{"(", 
               RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", 
              RowBox[{"a_", " ", "+", "  ", "b_"}], "]"}], "\[Rule]", 
             RowBox[{
              RowBox[{"name", "[", "a", "]"}], "+", " ", 
              RowBox[{"name", "[", "b", "]"}]}]}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"tmp", "=", 
           RowBox[{"tmp", "//.", 
            RowBox[{
             RowBox[{
              RowBox[{"(", 
               RowBox[{"name", ":", "\[Delta]1"}], ")"}], "[", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{"oo", ":", "ProductOp"}], ")"}], "[", 
               RowBox[{"a_", "  ", ",", "b__"}], "]"}], "]"}], ":>", 
             RowBox[{
              RowBox[{"oo", "[", 
               RowBox[{
                RowBox[{"name", "[", "a", "]"}], ",", "b"}], "]"}], "+", 
              RowBox[{"oo", "[", 
               RowBox[{"a", " ", ",", 
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"{", "b", "}"}], "]"}], ">", "1"}], ",", 
                  RowBox[{"name", "[", 
                   RowBox[{"oo", "[", "b", "]"}], "]"}], ",", 
                  RowBox[{"name", "[", "b", "]"}]}], "]"}]}], "]"}]}]}]}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{"tmp", "=", 
           RowBox[{"tmp", "//.", "sub"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{"Use", " ", "Mathematica", " ", "Dt", " ", "function"}], 
            "\[Implies]", 
            RowBox[{"some", " ", "Rules", " ", 
             RowBox[{"obsolete", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{
            "Test", " ", "code", " ", "to", " ", "handle", " ", "the", " ", 
             "hidden", " ", "variables", " ", "properly", " ", "with", " ", 
             "Dt"}], ",", " ", 
            RowBox[{"i", ".", "e", "."}], ",", " ", 
            RowBox[{
             RowBox[{"Dt", "[", 
              RowBox[{"f", "[", "1", "]"}], "]"}], "\[Rule]", "0"}]}], " ", 
           "*)"}], "\[IndentingNewLine]", 
          RowBox[{"tmp", "=", 
           RowBox[{"tmp", "/.", 
            RowBox[{
             RowBox[{
              RowBox[{"(", 
               RowBox[{"dname", ":", "\[Delta]1"}], ")"}], "[", "a_", "]"}], 
             "\[RuleDelayed]", " ", 
             RowBox[{"dname", "[", 
              RowBox[{"a", "/.", " ", 
               RowBox[{
                RowBox[{"h_", "[", 
                 RowBox[{"n_", "?", "NumberQ"}], "]"}], "\[Rule]", 
                RowBox[{"h", "[", 
                 RowBox[{"n", ",", "n$"}], "]"}]}]}], "]"}]}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"tmp", "=", 
           RowBox[{"tmp", "/.", " ", 
            RowBox[{"\[Delta]1", "\[Rule]", "Dt"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"tmp", "=", 
           RowBox[{"tmp", "/.", 
            RowBox[{
             RowBox[{
              RowBox[{"Dt", "[", "n$", "]"}], 
              RowBox[{
               RowBox[{
                RowBox[{"Derivative", "[", 
                 RowBox[{"0", ",", "1"}], "]"}], "[", "z_", "]"}], "[", 
               RowBox[{
                RowBox[{"n_", "?", "NumberQ"}], ",", "n$"}], "]"}]}], 
             "\[Rule]", 
             RowBox[{"d", "[", 
              RowBox[{"z", "[", "n", "]"}], "]"}]}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"tmp", "=", 
           RowBox[{
            RowBox[{"tmp", "/.", 
             RowBox[{
              RowBox[{"z_", "[", 
               RowBox[{
                RowBox[{"n_", "?", "NumberQ"}], ",", "n$"}], "]"}], ":>", 
              RowBox[{"z", "[", "n", "]"}]}]}], "/.", 
            RowBox[{"Dt", "\[Rule]", "\[Delta]1"}]}]}]}]}], 
        "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}], ";", 
       "\[IndentingNewLine]", "tmp"}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    TemplateBox[{"tudExpand"},
     "InactiveHead",
     BaseStyle->"Inactive",
     SyntaxForm->"Symbol",
     Tooltip->"Inactive[tudExpand]"], "[", "d", "]"}], "[", 
   RowBox[{"d", "[", 
    RowBox[{"U", "[", 
     RowBox[{"S", ",", "V", ",", 
      RowBox[{"IIII$522473", "[", "1", "]"}]}], "]"}], "]"}], "]"}], "//", 
  "Activate"}]}], "Input",
 CellChangeTimes->{{3.731807081664844*^9, 3.731807107011188*^9}, {
   3.731807240802843*^9, 3.731807251418709*^9}, {3.731807301005028*^9, 
   3.731807353579463*^9}, {3.731807459689752*^9, 3.7318074661244783`*^9}, {
   3.731807504040357*^9, 3.731807551605694*^9}, {3.731807616881233*^9, 
   3.731807727019928*^9}, {3.7318077570450077`*^9, 3.731807967670781*^9}, {
   3.731808000902299*^9, 3.73180801150058*^9}, {3.73180810587862*^9, 
   3.731808137054009*^9}, {3.7318081796925697`*^9, 3.731808183945552*^9}, 
   3.7318082233484077`*^9, {3.7318089046387873`*^9, 3.731808905534648*^9}, {
   3.731809009865191*^9, 3.731809056626993*^9}, {3.731809270464243*^9, 
   3.731809273414213*^9}, {3.731809304408112*^9, 3.7318093379186897`*^9}, {
   3.7318093977879677`*^9, 3.7318094350463953`*^9}, {3.731809489297042*^9, 
   3.7318095058146753`*^9}, {3.731809588898118*^9, 3.731809634440542*^9}, {
   3.731810584850613*^9, 3.731810609470997*^9}, {3.731810643786668*^9, 
   3.731810949086439*^9}, {3.73181099093581*^9, 3.7318110986861763`*^9}, {
   3.7318111314855223`*^9, 3.7318112036915216`*^9}, {3.731812022928843*^9, 
   3.731812124935392*^9}, {3.731812165749961*^9, 3.731812206924206*^9}, {
   3.731812237102319*^9, 3.731812338901623*^9}, {3.731812373229686*^9, 
   3.731812426439546*^9}, {3.731812465300068*^9, 3.7318127161347713`*^9}, {
   3.731813061110592*^9, 
   3.731813070784339*^9}},ExpressionUUID->"e1b2a8f2-60c3-43c7-b595-\
034d885c3de8"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"d", "[", 
    RowBox[{"IIII$522473", "[", "1", "]"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["U", 
     TagBox[
      RowBox[{"(", 
       RowBox[{"0", ",", "0", ",", "1"}], ")"}],
      Derivative],
     MultilineFunction->None], "[", 
    RowBox[{"S", ",", "V", ",", 
     RowBox[{"IIII$522473", "[", "1", "]"}]}], "]"}]}], "+", 
  RowBox[{
   RowBox[{"d", "[", "V", "]"}], " ", 
   RowBox[{
    SuperscriptBox["U", 
     TagBox[
      RowBox[{"(", 
       RowBox[{"0", ",", "1", ",", "0"}], ")"}],
      Derivative],
     MultilineFunction->None], "[", 
    RowBox[{"S", ",", "V", ",", 
     RowBox[{"IIII$522473", "[", "1", "]"}]}], "]"}]}], "+", 
  RowBox[{
   RowBox[{"d", "[", "S", "]"}], " ", 
   RowBox[{
    SuperscriptBox["U", 
     TagBox[
      RowBox[{"(", 
       RowBox[{"1", ",", "0", ",", "0"}], ")"}],
      Derivative],
     MultilineFunction->None], "[", 
    RowBox[{"S", ",", "V", ",", 
     RowBox[{"IIII$522473", "[", "1", "]"}]}], "]"}]}]}]], "Output",
 CellChangeTimes->{{3.731807936697028*^9, 3.731807969185603*^9}, 
   3.73180818522686*^9, 3.731808224246817*^9, 3.73180890637251*^9, 
   3.731809011078574*^9, {3.731809042121738*^9, 3.731809057502548*^9}, 
   3.73180927494267*^9, 3.731809338774767*^9, {3.73180940502007*^9, 
   3.73180943585518*^9}, {3.731809492640215*^9, 3.731809506688583*^9}, {
   3.731809590702013*^9, 3.7318096350337353`*^9}, {3.7318105941507072`*^9, 
   3.731810610598868*^9}, 3.731810645139164*^9, {3.7318107637585773`*^9, 
   3.73181077897808*^9}, 3.731810908970579*^9, {3.731810941305222*^9, 
   3.731810949923543*^9}, {3.731810999109659*^9, 3.731811049220969*^9}, 
   3.731811099611197*^9, {3.7318111346006813`*^9, 3.731811204468697*^9}, {
   3.731812627278694*^9, 3.731812653102124*^9}, 3.73181271696351*^9, 
   3.731813072346026*^9},ExpressionUUID->"d32e648e-ad9d-458b-9abb-\
c0ce512061f0"]
}, Open  ]]
},
WindowSize->{808, 655},
WindowMargins->{{Automatic, 76}, {Automatic, -739}},
Magnification->1.25,
FrontEndVersion->"11.2 for Mac OS X x86 (32-bit, 64-bit Kernel) (September \
10, 2017)",
StyleDefinitions->"tuTensorialStyle.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 695, 21, 71, "Input",ExpressionUUID->"7550822f-3b82-413d-82ab-6ad9d7967e15"],
Cell[1278, 45, 753, 19, 58, "Output",ExpressionUUID->"174e5f48-75a8-4008-894d-016262ea54aa"]
}, Open  ]],
Cell[CellGroupData[{
Cell[2068, 69, 614, 17, 71, "Input",ExpressionUUID->"9b6ad065-2952-475e-80ae-47e71498c094"],
Cell[2685, 88, 2055, 57, 74, "Output",ExpressionUUID->"8d11d047-7896-4849-8ab0-fa6ed60f96f1"]
}, Open  ]],
Cell[4755, 148, 420, 12, 54, "Input",ExpressionUUID->"b9f874e4-289a-40c7-958c-ee8835d70e72"],
Cell[CellGroupData[{
Cell[5200, 164, 218, 4, 51, "Input",ExpressionUUID->"5fbdccf0-d0f1-4b56-99c2-9541f08a2b0a"],
Cell[5421, 170, 147, 3, 31, "Output",ExpressionUUID->"12974971-11a8-4e21-b96b-7a4716772c6f"]
}, Open  ]],
Cell[CellGroupData[{
Cell[5605, 178, 7133, 185, 677, "Input",ExpressionUUID->"7e72c229-3d31-4d95-8300-ce03984c94a1"],
Cell[12741, 365, 2278, 43, 53, "Output",ExpressionUUID->"cc6dccd0-83bc-4073-a5d6-efaae63ef3de"],
Cell[15022, 410, 2084, 38, 51, "Output",ExpressionUUID->"156fea03-64e6-4684-a5de-435e92c2fd07"],
Cell[17109, 450, 2107, 38, 51, "Output",ExpressionUUID->"8dd25a13-9037-41b6-9631-d76c5f72f1af"],
Cell[19219, 490, 1969, 36, 51, "Output",ExpressionUUID->"1ce7aa51-5106-4c2d-9f89-f86023bc37ab"]
}, Open  ]],
Cell[CellGroupData[{
Cell[21225, 531, 2574, 69, 193, "Input",ExpressionUUID->"14c039e3-96bf-4017-836a-63133a8af41d"],
Cell[23802, 602, 6089, 191, 53, "Output",ExpressionUUID->"78dfd38c-3691-44f8-8d56-80ceddbf9201"],
Cell[29894, 795, 5532, 176, 53, "Output",ExpressionUUID->"3c281150-8512-4098-8840-b831c0927627"],
Cell[35429, 973, 4141, 134, 53, "Output",ExpressionUUID->"8dadad34-c434-4a48-8f07-ec8a5bda564a"],
Cell[39573, 1109, 4141, 134, 53, "Output",ExpressionUUID->"434837bd-fc51-4590-8ce4-99c379d9f410"],
Cell[43717, 1245, 2189, 64, 53, "Output",ExpressionUUID->"7afedfd2-fdc0-4216-bec8-ab52eb4241da"]
}, Open  ]],
Cell[CellGroupData[{
Cell[45943, 1314, 1622, 47, 206, "Input",ExpressionUUID->"48be67a9-4f1b-488a-bd4d-9111b25a8f6c"],
Cell[47568, 1363, 231, 6, 31, "Output",ExpressionUUID->"7dfa8b3a-33a5-4081-8c86-52d89fc83a38"],
Cell[47802, 1371, 287, 8, 31, "Output",ExpressionUUID->"3ad3fca0-12e6-4e57-9222-6f0f9cd71890"],
Cell[48092, 1381, 380, 11, 31, "Output",ExpressionUUID->"ae6726b3-3bec-4c75-8b62-777ab807dfdc"]
}, Open  ]],
Cell[CellGroupData[{
Cell[48509, 1397, 13646, 326, 892, "Input",ExpressionUUID->"e1b2a8f2-60c3-43c7-b595-034d885c3de8"],
Cell[62158, 1725, 1900, 48, 92, "Output",ExpressionUUID->"d32e648e-ad9d-458b-9abb-c0ce512061f0"]
}, Open  ]]
}
]
*)

